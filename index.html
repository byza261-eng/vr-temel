<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>HaritaG√∂z - AR Harita Okuryazarlƒ±ƒüƒ± Sim√ºlat√∂r√º</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* ========= Tek ekrana sƒ±ƒüsƒ±n, scroll olmasƒ±n ========= */
    html, body {
      height: 100%;
      overflow: hidden;
      -webkit-overflow-scrolling: auto;
      background: linear-gradient(135deg, #1a2a3a 0%, #2d4a5c 100%);
    }

    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #ffffff;
      -webkit-tap-highlight-color: transparent;
    }

    /* Uygulama k√∂k√º: scale uygulanacak alan */
    #appRoot{
      width: 100vw;
      height: 100vh;
      transform-origin: top left;
      will-change: transform;
      overflow: hidden;
    }

    /* Tƒ±klanabilirler i√ßin iOS tap iyile≈ütirme */
    button, .layer-btn, .direction-btn, .quiz-option, .ar-info-point {
      touch-action: manipulation;
    }

    .header {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
      border-bottom: 2px solid rgba(76, 175, 80, 0.3);
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .stats { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    .stat-item { text-align: center; min-width: 70px; }
    .stat-value { font-size: 20px; font-weight: bold; color: #FFC107; }
    .stat-label { font-size: 12px; color: #B0BEC5; }

    .pill {
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
      user-select: none;
      -webkit-user-select: none;
    }
    .pill:hover { transform: scale(1.02); }

    .bep-toggle { background: #2196F3; }
    .bep-toggle.active { background: #FF9800; }

    .vr-toggle { background: #6A1B9A; }
    .vr-toggle.active { background: #D32F2F; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px 12px;
      height: calc(100vh - 74px); /* header y√ºksekliƒüi */
      overflow: hidden;           /* tek ekran */
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 14px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
      font-size: 22px;
      margin-bottom: 12px;
      color: #4CAF50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .task-prompt {
      background: rgba(255, 193, 7, 0.2);
      border: 2px solid #FFC107;
      padding: 14px;
      border-radius: 14px;
      margin-bottom: 12px;
    }
    .task-prompt-title { font-size: 16px; font-weight: bold; color: #FFC107; margin-bottom: 6px; }
    .task-prompt-desc { font-size: 14px; color: #E0E0E0; }

    .ar-simulator {
      background: #1a1a1a;
      border-radius: 14px;
      padding: 14px;
      position: relative;
      border: 3px solid #4CAF50;
      overflow: hidden;
    }

    .ar-viewport {
      position: relative;
      width: 100%;
      height: 300px; /* tek ekrana sƒ±ƒümasƒ± i√ßin daha kompakt */
      background: linear-gradient(to bottom, #87CEEB 0%, #90EE90 50%, #8B4513 100%);
      border-radius: 10px;
      overflow: hidden;
    }

    .map-layers {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    .layer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      transition: opacity 0.25s;
    }
    .layer.hidden { opacity: 0; pointer-events: none; }

    .topography-layer {
      background: repeating-linear-gradient(
        45deg, transparent, transparent 10px,
        rgba(139, 69, 19, 0.2) 10px,
        rgba(139, 69, 19, 0.2) 20px
      );
    }

    .roads-layer {
      background: repeating-linear-gradient(
        90deg, transparent, transparent 50px,
        rgba(255, 255, 0, 0.6) 50px,
        rgba(255, 255, 0, 0.6) 52px
      ),
      repeating-linear-gradient(
        0deg, transparent, transparent 80px,
        rgba(255, 255, 0, 0.6) 80px,
        rgba(255, 255, 0, 0.6) 82px
      );
    }

    .water-layer {
      background:
        radial-gradient(circle at 30% 70%, rgba(30, 144, 255, 0.6) 0%, transparent 30%),
        radial-gradient(circle at 70% 40%, rgba(30, 144, 255, 0.5) 0%, transparent 25%);
    }

    .settlement-layer {
      background:
        radial-gradient(circle at 50% 30%, rgba(255, 165, 0, 0.4) 0%, transparent 20%),
        radial-gradient(circle at 20% 60%, rgba(255, 165, 0, 0.3) 0%, transparent 15%),
        radial-gradient(circle at 80% 70%, rgba(255, 165, 0, 0.3) 0%, transparent 15%);
    }

    .risk-layer {
      background:
        radial-gradient(circle at 60% 80%, rgba(255, 0, 0, 0.5) 0%, transparent 25%),
        radial-gradient(circle at 25% 30%, rgba(255, 0, 0, 0.4) 0%, transparent 20%);
    }

    .ar-info-point {
      position: absolute;
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .layer-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .layer-btn {
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      -webkit-user-select: none;
    }

    .layer-btn.topography { background: linear-gradient(135deg, #8B4513, #D2691E); color: white; }
    .layer-btn.roads { background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; }
    .layer-btn.water { background: linear-gradient(135deg, #1E90FF, #4169E1); color: white; }
    .layer-btn.settlement { background: linear-gradient(135deg, #FF6347, #FF8C00); color: white; }
    .layer-btn.risk { background: linear-gradient(135deg, #DC143C, #8B0000); color: white; }
    .layer-btn.inactive { opacity: 0.4; filter: grayscale(100%); }

    .direction-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-width: 200px;
      margin: 12px auto 0;
    }

    .direction-btn {
      padding: 12px;
      background: #2196F3;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Tek ekrana sƒ±ƒümasƒ± i√ßin g√∂rev/ba≈üarƒ±m/test b√∂l√ºmleri kompakt */
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      height: 100%;
    }

    .missions, .achievements { display: grid; gap: 10px; }
    .missions { grid-template-columns: 1fr; max-height: 190px; overflow: hidden; }
    .achievements { grid-template-columns: repeat(2, 1fr); max-height: 190px; overflow: hidden; }

    .mission-card {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(76, 175, 80, 0.2));
      padding: 12px;
      border-radius: 14px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }
    .mission-title { font-size: 14px; font-weight: bold; margin-bottom: 6px; color: #4CAF50; }
    .mission-desc { font-size: 12px; color: #CFD8DC; margin-bottom: 8px; }
    .mission-reward { font-size: 12px; color: #FFC107; font-weight: bold; }

    .mission-status {
      position: absolute;
      top: 8px; right: 8px;
      width: 24px; height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: rgba(0,0,0,0.35);
    }

    .achievement {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 14px;
      text-align: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    .achievement.unlocked { border-color: #FFC107; background: rgba(255, 193, 7, 0.1); }
    .achievement-icon { font-size: 28px; margin-bottom: 6px; filter: grayscale(100%); }
    .achievement.unlocked .achievement-icon { filter: grayscale(0%); }
    .achievement-name { font-size: 12px; font-weight: bold; }
    .achievement-desc { font-size: 10px; color: #B0BEC5; }

    .quiz { display: grid; gap: 10px; max-height: 220px; overflow: hidden; }
    .quiz-question { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 14px; }
    .quiz-question-text { font-size: 13px; margin-bottom: 10px; color: #E0E0E0; }
    .quiz-options { display: grid; gap: 8px; }
    .quiz-option {
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
      user-select: none;
      -webkit-user-select: none;
    }
    .quiz-option.selected { border-color: #FFC107; background: rgba(255, 193, 7, 0.2); }
    .quiz-option.correct { border-color: #4CAF50; background: rgba(76, 175, 80, 0.2); }
    .quiz-option.wrong { border-color: #F44336; background: rgba(244, 67, 54, 0.2); }

    .btn-primary {
      background: linear-gradient(135deg, #4CAF50, #8BC34A);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 22px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .result-panel {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(33, 150, 243, 0.2));
      padding: 14px;
      border-radius: 14px;
      text-align: center;
      margin-top: 10px;
      border: 2px solid #4CAF50;
    }
    .result-score { font-size: 28px; font-weight: bold; color: #FFC107; margin-bottom: 6px; }
    .result-message { font-size: 14px; color: #E0E0E0; }

    .hidden { display: none; }

    /* ========= VR Overlay ========= */
    .vr-stage{
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;

      visibility: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
    }

    body.vr-on .vr-stage{
      visibility: visible;
      opacity: 1;
      pointer-events: auto;
    }

    /* VR a√ßƒ±nca arka tarafƒ±n kaymasƒ±nƒ± kesin engelle */
    body.vr-on, body.vr-on html{
      overflow: hidden !important;
      overscroll-behavior: none;
      touch-action: none;
    }

    .vr-topbar{
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10000;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .vr-close{
      background: rgba(211,47,47,0.95);
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .vr-eye{
      position: absolute;
      top: 0;
      width: 50vw;
      height: 100vh;
      overflow: hidden;
    }
    .vr-eye.left{ left: 0; }
    .vr-eye.right{ right: 0; }

    .vr-content{
      transform-origin: top left;
      will-change: transform;
    }

    .hud{
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 10001;
      font-size: 12px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      max-width: 78vw;
    }

    .focus-ring{
      outline: 3px solid rgba(255,193,7,0.95);
      outline-offset: 4px;
      border-radius: 12px;
    }

    /* BEP */
    body.bep-mode { font-size: 18px; }
    body.bep-mode .section-title { font-size: 26px; }
  </style>
</head>

<body>
  <div id="appRoot">
    <div class="header">
      <div class="logo">üó∫Ô∏è HaritaG√∂z</div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="score">0</div>
          <div class="stat-label">Puan</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="level">1</div>
          <div class="stat-label">Seviye</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="missions-completed">0/8</div>
          <div class="stat-label">G√∂rev</div>
        </div>

        <button class="pill bep-toggle" id="bep-toggle" type="button">BEP Modu</button>
        <button class="pill vr-toggle" id="vr-toggle" type="button">VR Modu</button>
      </div>
    </div>

    <div class="container">
      <div class="section">
        <div class="section-title">üéØ AR Harita Sim√ºlat√∂r√º</div>

        <div class="task-prompt" id="current-task">
          <div class="task-prompt-title">Ho≈ü Geldiniz!</div>
          <div class="task-prompt-desc">Katmanlarƒ± a√ßƒ±p kapatƒ±n. Y√∂n butonlarƒ±yla farklƒ± y√∂ne bakƒ±n. VR‚Äôde de aynƒ±sƒ± √ßalƒ±≈üƒ±r.</div>
        </div>

        <div class="ar-simulator">
          <div class="ar-viewport" id="ar-viewport">
            <div class="map-layers">
              <div class="layer topography-layer" id="layer-topography"></div>
              <div class="layer roads-layer hidden" id="layer-roads"></div>
              <div class="layer water-layer hidden" id="layer-water"></div>
              <div class="layer settlement-layer hidden" id="layer-settlement"></div>
              <div class="layer risk-layer hidden" id="layer-risk"></div>
            </div>

            <div class="ar-info-point" style="top: 26%; left: 26%;" data-info="topography">üìä Topografya</div>
            <div class="ar-info-point" style="top: 70%; left: 58%;" data-info="risk">‚ö†Ô∏è Risk</div>
            <div class="ar-info-point" style="top: 40%; left: 70%;" data-info="water">üíß Su</div>
          </div>

          <div class="layer-controls">
            <button class="layer-btn topography" data-layer="topography" type="button">üèîÔ∏è Topografya</button>
            <button class="layer-btn roads inactive" data-layer="roads" type="button">üõ£Ô∏è Ula≈üƒ±m</button>
            <button class="layer-btn water inactive" data-layer="water" type="button">üíß Su</button>
            <button class="layer-btn settlement inactive" data-layer="settlement" type="button">üèòÔ∏è Yerle≈üim</button>
            <button class="layer-btn risk inactive" data-layer="risk" type="button">‚ö†Ô∏è Risk</button>
          </div>

          <div class="direction-controls">
            <button class="direction-btn" data-direction="nw" type="button">‚ÜñÔ∏è</button>
            <button class="direction-btn" data-direction="n" type="button">‚¨ÜÔ∏è</button>
            <button class="direction-btn" data-direction="ne" type="button">‚ÜóÔ∏è</button>
            <button class="direction-btn" data-direction="w" type="button">‚¨ÖÔ∏è</button>
            <button class="direction-btn" data-direction="e" type="button">‚û°Ô∏è</button>
            <button class="direction-btn" data-direction="sw" type="button">‚ÜôÔ∏è</button>
            <button class="direction-btn" data-direction="s" type="button">‚¨áÔ∏è</button>
            <button class="direction-btn" data-direction="se" type="button">‚ÜòÔ∏è</button>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div class="section">
          <div class="section-title">üéØ G√∂revler</div>
          <div class="missions" id="missions"></div>
        </div>

        <div class="section">
          <div class="section-title">üèÜ Ba≈üarƒ±mlar</div>
          <div class="achievements" id="achievements"></div>
        </div>
      </div>

      <div class="section" id="quiz-section">
        <div class="section-title">üìù Test</div>
        <div class="quiz" id="quiz"></div>
        <button class="btn-primary" id="check-answers" type="button">Cevaplarƒ± Kontrol Et</button>

        <div class="result-panel hidden" id="quiz-result">
          <div class="result-score" id="quiz-score"></div>
          <div class="result-message" id="quiz-message"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- VR Overlay -->
  <div class="vr-stage" id="vr-stage" aria-hidden="true">
    <div class="vr-topbar">
      <button class="vr-close" id="vr-close" type="button">‚úï Kapat</button>
    </div>

    <div class="vr-eye left"><div class="vr-content" id="vr-left"></div></div>
    <div class="vr-eye right"><div class="vr-content" id="vr-right"></div></div>
  </div>

  <div class="hud hidden" id="hud">Hazƒ±r</div>

  <script>
    // ========= Tap baƒülama: iOS'ta "kesin tƒ±k" =========
    function bindTap(el, handler){
      if (!el) return;
      const fire = (e) => {
        try { e.preventDefault?.(); } catch(_){}
        handler();
      };
      el.addEventListener('pointerup', fire, {passive:false});
      el.addEventListener('touchend', fire, {passive:false});
      el.addEventListener('click', (e)=>{ e.preventDefault(); handler(); }, false);
    }

    function showHUD(msg, ms = 1400){
      const hud = document.getElementById('hud');
      hud.textContent = msg;
      hud.classList.remove('hidden');
      clearTimeout(showHUD._t);
      showHUD._t = setTimeout(()=>hud.classList.add('hidden'), ms);
    }

    // ========= Game State =========
    const gameState = {
      score: 0,
      level: 1,
      completedMissions: 0,
      activeLayers: ['topography'],
      currentDirection: 'n',
      bepMode: false
    };
    gameState.directionsExplored = 0;
    gameState.layersUsed = new Set();
    gameState.riskPointClicked = false;
    gameState.waterPointClicked = false;
    gameState.roadsExplored = false;
    gameState.quizCompleted = false;

    const missions = [
      { id: 1, title: 'Katmanlarƒ± Ke≈üfet', desc: 'En az 3 katmanƒ± a√ß', reward: 50, status: 'active', check: () => gameState.activeLayers.length >= 3 },
      { id: 2, title: 'Y√∂n Bul', desc: '4 farklƒ± y√∂ne bak', reward: 75, status: 'locked', check: () => gameState.directionsExplored >= 4 },
      { id: 3, title: 'Risk Analizi', desc: 'Risk katmanƒ±nƒ± a√ß + risk noktasƒ±na dokun', reward: 100, status: 'locked', check: () => gameState.activeLayers.includes('risk') && gameState.riskPointClicked },
      { id: 4, title: 'Su Kaynaklarƒ±', desc: 'Su katmanƒ± + su noktasƒ±na dokun', reward: 100, status: 'locked', check: () => gameState.activeLayers.includes('water') && gameState.waterPointClicked },
      { id: 5, title: 'G√ºzergah', desc: 'Ula≈üƒ±m katmanƒ±nƒ± ke≈üfet', reward: 150, status: 'locked', check: () => gameState.activeLayers.includes('roads') && gameState.roadsExplored },
      { id: 6, title: 'Yerle≈üim', desc: 'Yerle≈üim katmanƒ±nƒ± a√ß', reward: 150, status: 'locked', check: () => gameState.activeLayers.includes('settlement') },
      { id: 7, title: 'Harita Uzmanƒ±', desc: 'Testi tamamla', reward: 200, status: 'locked', check: () => gameState.quizCompleted },
      { id: 8, title: 'AR Ustasƒ±', desc: '1000 puana ula≈ü', reward: 300, status: 'locked', check: () => gameState.completedMissions >= 7 && gameState.score >= 1000 }
    ];

    const achievements = [
      { id: 1, icon: 'üó∫Ô∏è', name: 'ƒ∞lk Ke≈üif', desc: 'ƒ∞lk katmanƒ± a√ßtƒ±n', unlocked: false },
      { id: 2, icon: 'üß≠', name: 'Y√∂n Bulma', desc: '4 y√∂ne baktƒ±n', unlocked: false },
      { id: 3, icon: '‚ö†Ô∏è', name: 'Risk', desc: 'Risk noktasƒ±nƒ± buldun', unlocked: false },
      { id: 4, icon: 'üíß', name: 'Su', desc: 'Su noktasƒ±nƒ± buldun', unlocked: false },
      { id: 5, icon: 'üèÜ', name: 'ƒ∞lk G√∂rev', desc: 'ƒ∞lk g√∂revi tamamladƒ±n', unlocked: false },
      { id: 6, icon: 'üìö', name: '500', desc: '500 puan', unlocked: false },
      { id: 7, icon: 'üéì', name: 'Test', desc: 'Testi ge√ßtin', unlocked: false },
      { id: 8, icon: 'üëë', name: 'Usta', desc: 'T√ºm g√∂revler', unlocked: false }
    ];

    const quizQuestions = [
      { question: 'Y√ºksekliƒüi g√∂steren katman?', options: ['Topografya', 'Ula≈üƒ±m', 'Yerle≈üim', 'Risk'], correct: 0 },
      { question: 'Sel riski i√ßin birlikte?', options: ['Sadece risk', 'Su + topografya', 'Sadece yerle≈üim', 'Sadece ula≈üƒ±m'], correct: 1 },
      { question: 'N√ºfus yoƒüunluƒüu?', options: ['Topografya', 'Su', 'Yerle≈üim', 'Ula≈üƒ±m'], correct: 2 },
      { question: 'G√ºvenli g√ºzergah?', options: ['Ula≈üƒ±m + risk', 'Sadece topo', 'Sadece su', 'Sadece yerle≈üim'], correct: 0 },
      { question: 'AR avantajƒ±?', options: ['Pahalƒ±dƒ±r', '√áevre + harita birle≈üir', 'Sadece sƒ±nƒ±fta', 'Tek katman'], correct: 1 }
    ];

    // ========= Render =========
    function renderMissions(){
      const container = document.getElementById('missions');
      container.innerHTML = missions.map(m => `
        <div class="mission-card ${m.status}">
          <div class="mission-status">${m.status === 'locked' ? 'üîí' : m.status === 'active' ? '‚ö°' : '‚úÖ'}</div>
          <div class="mission-title">${m.title}</div>
          <div class="mission-desc">${m.desc}</div>
          <div class="mission-reward">+${m.reward} Puan</div>
        </div>
      `).join('');
      updateMissionCounter();
    }

    function renderAchievements(){
      const container = document.getElementById('achievements');
      container.innerHTML = achievements.map(a => `
        <div class="achievement ${a.unlocked ? 'unlocked' : ''}">
          <div class="achievement-icon">${a.icon}</div>
          <div class="achievement-name">${a.name}</div>
          <div class="achievement-desc">${a.desc}</div>
        </div>
      `).join('');
    }

    function renderQuiz(){
      const container = document.getElementById('quiz');
      container.innerHTML = quizQuestions.map((q,i)=>`
        <div class="quiz-question" data-question="${i}">
          <div class="quiz-question-text">${i+1}. ${q.question}</div>
          <div class="quiz-options">
            ${q.options.map((opt,j)=>`
              <div class="quiz-option" data-question="${i}" data-option="${j}">${opt}</div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // ========= Stats / Score =========
    function updateStats(){
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('level').textContent = gameState.level;
    }
    function updateMissionCounter(){
      document.getElementById('missions-completed').textContent = `${gameState.completedMissions}/${missions.length}`;
    }

    function addScore(points){
      gameState.score += points;
      if (gameState.score >= 500 && !achievements[5].unlocked) unlockAchievement(6);

      const newLevel = Math.floor(gameState.score / 200) + 1;
      if (newLevel > gameState.level) gameState.level = newLevel;

      updateStats();
    }

    function unlockAchievement(id){
      const a = achievements.find(x => x.id === id);
      if (a && !a.unlocked){
        a.unlocked = true;
        renderAchievements();
        addScore(50);
      }
    }

    // ========= Interactions =========
    function toggleLayer(layerName){
      const layer = document.getElementById(`layer-${layerName}`);
      const btn = document.querySelector(`.layer-btn[data-layer="${layerName}"]`);

      if (layer.classList.contains('hidden')){
        layer.classList.remove('hidden');
        btn.classList.remove('inactive');
        if (!gameState.activeLayers.includes(layerName)) gameState.activeLayers.push(layerName);
        gameState.layersUsed.add(layerName);
      } else {
        layer.classList.add('hidden');
        btn.classList.add('inactive');
        gameState.activeLayers = gameState.activeLayers.filter(l => l !== layerName);
      }

      if (gameState.layersUsed.size === 1 && !achievements[0].unlocked) unlockAchievement(1);
      if (layerName === 'roads') gameState.roadsExplored = true;

      checkMissions();
      refreshVRStereo();
    }

    function changeDirection(direction){
      gameState.currentDirection = direction;
      gameState.directionsExplored++;

      const viewport = document.getElementById('ar-viewport');
      viewport.style.filter = 'brightness(1.2)';
      setTimeout(()=>viewport.style.filter='brightness(1)', 180);

      if (gameState.directionsExplored >= 4 && !achievements[1].unlocked) unlockAchievement(2);

      checkMissions();
      refreshVRStereo();
    }

    function clickInfoPoint(type){
      if (type === 'risk'){
        gameState.riskPointClicked = true;
        if (!achievements[2].unlocked) unlockAchievement(3);
      }
      if (type === 'water'){
        gameState.waterPointClicked = true;
        if (!achievements[3].unlocked) unlockAchievement(4);
      }

      addScore(25);
      checkMissions();
      refreshVRStereo();
    }

    function checkMissions(){
      missions.forEach((m, idx) => {
        if (m.status === 'active' && m.check()) completeMission(idx);
        else if (m.status === 'locked' && idx > 0) {
          if (missions[idx - 1].status === 'completed') m.status = 'active';
        }
      });
      renderMissions();
      refreshVRStereo();
    }

    function completeMission(index){
      const m = missions[index];
      if (m.status !== 'completed'){
        m.status = 'completed';
        gameState.completedMissions++;
        addScore(m.reward);

        if (gameState.completedMissions === 1 && !achievements[4].unlocked) unlockAchievement(5);
        if (index < missions.length - 1) missions[index + 1].status = 'active';

        renderMissions();
      }
    }

    function selectQuizOption(opt){
      const qId = opt.dataset.question;
      document.querySelectorAll(`.quiz-option[data-question="${qId}"]`).forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      refreshVRStereo();
    }

    function checkQuizAnswers(){
      let correctCount = 0;

      quizQuestions.forEach((q,i)=>{
        const selected = document.querySelector(`.quiz-option[data-question="${i}"].selected`);
        const all = document.querySelectorAll(`.quiz-option[data-question="${i}"]`);
        if (!selected) return;

        const chosen = parseInt(selected.dataset.option,10);
        all.forEach(o=>{
          const idx = parseInt(o.dataset.option,10);
          if (idx === q.correct) o.classList.add('correct');
          else if (o.classList.contains('selected')) o.classList.add('wrong');
        });
        if (chosen === q.correct) correctCount++;
      });

      const resultPanel = document.getElementById('quiz-result');
      const scoreEl = document.getElementById('quiz-score');
      const msgEl = document.getElementById('quiz-message');

      scoreEl.textContent = `${correctCount}/${quizQuestions.length}`;
      const pct = (correctCount / quizQuestions.length) * 100;

      if (pct >= 80){
        msgEl.textContent = 'M√ºkemmel! üèÜ';
        addScore(200);
        if (!achievements[6].unlocked) unlockAchievement(7);
      } else if (pct >= 60){
        msgEl.textContent = 'ƒ∞yi! üëç';
        addScore(150);
      } else {
        msgEl.textContent = 'Daha fazla pratik! üí™';
        addScore(100);
      }

      resultPanel.classList.remove('hidden');
      document.getElementById('check-answers').disabled = true;

      gameState.quizCompleted = true;
      checkMissions();
      refreshVRStereo();
    }

    function toggleBEPMode(){
      gameState.bepMode = !gameState.bepMode;
      document.body.classList.toggle('bep-mode');
      const btn = document.getElementById('bep-toggle');
      btn.classList.toggle('active');
      btn.textContent = gameState.bepMode ? 'Normal Mod' : 'BEP Modu';
      refreshVRStereo();
      fitAppToScreen();
    }

    // ========= Fit-to-screen (Normal mod) =========
    function fitAppToScreen(){
      const app = document.getElementById('appRoot');
      if (!app) return;

      // √∂l√ß√ºm i√ßin √∂nce scale sƒ±fƒ±rla
      app.style.transform = 'scale(1)';

      requestAnimationFrame(() => {
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        const rect = app.getBoundingClientRect();
        const contentW = rect.width;
        const contentH = rect.height;

        const scale = Math.min(vw / contentW, vh / contentH);
        const finalScale = Math.min(1, scale); // b√ºy√ºtme yok, sadece sƒ±ƒüdƒ±r

        app.style.transform = `scale(${finalScale})`;
      });
    }

    // ========= VR =========
    const vrState = { enabled:false };

    function calcVrScale(){
      // Her g√∂z 50vw x 100vh, i√ßerik 100vw x 100vh gibi √ßiziliyor.
      const eyeW = window.innerWidth / 2;
      const eyeH = window.innerHeight;

      const contentW = window.innerWidth;
      const contentH = window.innerHeight;

      const sW = eyeW / contentW;
      const sH = eyeH / contentH;

      return Math.min(sW, sH) * 0.98;
    }

    function buildVRStereo(){
      const left = document.getElementById('vr-left');
      const right = document.getElementById('vr-right');
      left.innerHTML = '';
      right.innerHTML = '';

      const headerClone = document.querySelector('.header').cloneNode(true);
      const containerClone = document.querySelector('.container').cloneNode(true);

      // klon tƒ±klanmasƒ±n (kontrol ger√ßek sayfada)
      headerClone.style.pointerEvents = 'none';
      containerClone.style.pointerEvents = 'none';

      const wrap = document.createElement('div');
      wrap.className = 'vr-content';
      wrap.style.width = '100vw';
      wrap.style.height = '100vh';
      wrap.appendChild(headerClone);
      wrap.appendChild(containerClone);

      const wrap2 = wrap.cloneNode(true);

      const s = calcVrScale();
      wrap.style.transform = `scale(${s})`;
      wrap2.style.transform = `scale(${s})`;

      left.appendChild(wrap);
      right.appendChild(wrap2);
    }

    function teardownVRStereo(){
      document.getElementById('vr-left').innerHTML = '';
      document.getElementById('vr-right').innerHTML = '';
    }

    function refreshVRStereo(){
      if (!vrState.enabled) return;
      buildVRStereo();
    }

    function openVR(){
      vrState.enabled = true;
      document.body.classList.add('vr-on');

      const stage = document.getElementById('vr-stage');
      stage.setAttribute('aria-hidden', 'false');

      const vrBtn = document.getElementById('vr-toggle');
      vrBtn.classList.add('active');
      vrBtn.textContent = 'VR Kapat';

      // arka ekranƒ± kesin kilitle
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      // VR stereo √ßiz
      setTimeout(() => {
        buildVRStereo();
        showHUD('VR A√ßƒ±k | Kapat: √ºstte ‚úï veya VR Kapat', 2000);
      }, 60);
    }

    function closeVR(){
      vrState.enabled = false;
      document.body.classList.remove('vr-on');

      const stage = document.getElementById('vr-stage');
      stage.setAttribute('aria-hidden', 'true');

      const vrBtn = document.getElementById('vr-toggle');
      vrBtn.classList.remove('active');
      vrBtn.textContent = 'VR Modu';

      teardownVRStereo();
      showHUD('VR Kapalƒ±', 900);

      // normal ekran tekrar sƒ±ƒüsƒ±n
      setTimeout(() => fitAppToScreen(), 60);
    }

    function toggleVRMode(){
      try{
        if (vrState.enabled) closeVR();
        else openVR();
      }catch(e){
        alert('VR hata: ' + (e?.message || e));
      }
    }

    // ========= Event listeners =========
    function setupEventListeners(){
      // layer buttons
      document.querySelectorAll('.layer-btn').forEach(btn => {
        bindTap(btn, ()=>toggleLayer(btn.dataset.layer));
      });

      // direction buttons
      document.querySelectorAll('.direction-btn').forEach(btn => {
        bindTap(btn, ()=>changeDirection(btn.dataset.direction));
      });

      // info points
      document.querySelectorAll('.ar-info-point').forEach(p => {
        bindTap(p, ()=>clickInfoPoint(p.dataset.info));
      });

      // quiz options
      document.querySelectorAll('.quiz-option').forEach(opt => {
        bindTap(opt, ()=>selectQuizOption(opt));
      });

      bindTap(document.getElementById('check-answers'), checkQuizAnswers);
      bindTap(document.getElementById('bep-toggle'), toggleBEPMode);

      // VR buttons (hem header hem VR overlay close)
      bindTap(document.getElementById('vr-toggle'), toggleVRMode);
      bindTap(document.getElementById('vr-close'), closeVR);

      // VR overlay: arka kaymayƒ± engelle
      const stage = document.getElementById('vr-stage');
      stage.addEventListener('touchmove', (e)=>e.preventDefault(), {passive:false});
      stage.addEventListener('wheel', (e)=>e.preventDefault(), {passive:false});
    }

    // ========= Init =========
    function init(){
      renderMissions();
      renderAchievements();
      renderQuiz();
      setupEventListeners();
      updateStats();
      updateMissionCounter();
      fitAppToScreen();

      window.addEventListener('resize', () => {
        fitAppToScreen();
        refreshVRStereo();
      });
      window.addEventListener('orientationchange', () => {
        setTimeout(()=>{ fitAppToScreen(); refreshVRStereo(); }, 250);
      });

      showHUD('Hazƒ±r ‚úÖ', 1000);
    }

    init();
  </script>
</body>
</html>
