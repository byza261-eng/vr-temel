<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HaritaGÃ¶z - KatmanlÄ± TÃ¼rkiye VR SimÃ¼latÃ¶r</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg1:#0f1f2c; --bg2:#183447;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --green:#4CAF50; --amber:#FFC107; --blue:#2196F3; --red:#F44336;
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
    }

    /* HEADER */
    .header{
      position:sticky;top:0;z-index:30;
      background:rgba(0,0,0,.35);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .logo{font-weight:900;color:var(--green);font-size:20px;display:flex;gap:8px;align-items:center}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      padding:7px 10px;
      font-size:13px;
      display:flex;gap:6px;align-items:center
    }
    .pill b{color:var(--amber)}
    .btn{
      border:none;cursor:pointer;border-radius:12px;
      padding:10px 12px;font-weight:900;color:#fff;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      transition:transform .12s ease,opacity .12s ease;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:active{transform:scale(.98)}
    .btn-blue{background:linear-gradient(135deg,#1e88e5,#42a5f5);border:none}
    .btn-green{background:linear-gradient(135deg,var(--green),#8BC34A);border:none}
    .btn-warn{background:linear-gradient(135deg,#ff9800,#ffb300);border:none;color:#222}
    .btn-danger{background:linear-gradient(135deg,#d32f2f,#ff5252);border:none}

    .container{max-width:1200px;margin:0 auto;padding:14px 12px 26px}
    .section{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      margin:12px 0;
      backdrop-filter:blur(10px);
    }
    .section-title{
      font-size:18px;font-weight:900;color:var(--green);
      display:flex;gap:8px;align-items:center;margin-bottom:10px;
    }

    .map-frame{
      border-radius:16px;
      overflow:hidden;
      border:2px solid rgba(76,175,80,.45);
      background:#0b1218;
    }
    #mapNormal{width:100%;height:56vh;min-height:380px}

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
      margin-top:10px;
    }

    .layerbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .layer-btn{
      border:none;cursor:pointer;border-radius:14px;
      padding:12px 12px;font-weight:900;font-size:14px;
      display:flex;gap:8px;align-items:center;
      transition:transform .12s ease,opacity .12s ease,filter .12s ease;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
    }
    .layer-btn:active{transform:scale(.98)}
    .layer-btn.off{opacity:.55;filter:grayscale(.85)}
    .layer-topo{background:linear-gradient(135deg,#6d4c41,#d2691e);color:#fff}
    .layer-water{background:linear-gradient(135deg,#1e88e5,#1565c0);color:#fff}
    .layer-roads{background:linear-gradient(135deg,#ffd54f,#ffb300);color:#222}
    .layer-settle{background:linear-gradient(135deg,#ff7043,#f4511e);color:#fff}
    .layer-risk{background:linear-gradient(135deg,#d32f2f,#7f0000);color:#fff}

    .note{
      font-size:13px;color:rgba(255,255,255,.8);line-height:1.45
    }

    /* ===== VR OVERLAY ===== */
    body.vr-lock{
      overflow:hidden;
      position:fixed;
      width:100%;
      height:100%;
      inset:0;
      touch-action:none;
    }
    #vrOverlay{
      position:fixed;inset:0;z-index:9999;
      background:#000;display:none;
    }
    #vrOverlay.on{display:block}

    .vr-stage{
      position:absolute;inset:0;
      display:flex;width:100%;height:100%;
    }
    .eye{position:relative;width:50%;height:100%;overflow:hidden;background:#000}
    .eye .map{position:absolute;inset:0;width:100%;height:100%}

    /* VR HUD - clickable and always visible */
    .vr-hud{
      position:absolute;
      top: env(safe-area-inset-top, 10px);
      left:0;right:0;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:center;
      padding:10px;
      z-index:200;
      pointer-events:auto;
    }
    .vr-hud *{pointer-events:auto}

    /* VR Bottom controls */
    .vr-bottom{
      position:absolute;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
      left:0;right:0;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:center;
      padding:0 10px;
      z-index:200;
      pointer-events:auto;
    }

    /* Compass */
    .compass{
      position:absolute;
      right:12px;
      top: calc(env(safe-area-inset-top, 10px) + 12px);
      z-index:220;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:14px;
      min-width:110px;
      text-align:center;
      pointer-events:none;
    }
    .compass .dir{font-weight:900;color:#fff;font-size:14px}
    .compass .deg{font-size:12px;color:rgba(255,255,255,.8)}

    #rotateHint{
      display:none;
      position:absolute;inset:0;z-index:300;
      background:rgba(0,0,0,.85);
      align-items:center;justify-content:center;
      padding:20px;text-align:center;
      font-weight:900;font-size:18px;
    }
    #rotateHint.on{display:flex}

    /* Slight â€œ3D feelâ€ for VR: add depth by skewing overlays a bit */
    .vr-3d{
      filter: contrast(1.05) saturate(1.15);
    }

    /* Leaflet attribution small */
    .leaflet-control-attribution{font-size:10px}
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">ğŸ—ºï¸ HaritaGÃ¶z</div>
    <div class="right">
      <div class="pill">Puan: <b id="score">0</b></div>
      <div class="pill">Seviye: <b id="level">1</b></div>
      <button class="btn" id="bepBtn">BEP Modu</button>
      <button class="btn btn-blue" id="vrBtn">ğŸ¥½ VR Modu</button>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <div class="section-title">ğŸ”ï¸ Normal Mod â€“ TÃ¼rkiye Topografya + Katmanlar</div>

      <div class="map-frame">
        <div id="mapNormal"></div>
      </div>

      <div class="controls">
        <div class="layerbar" id="layerBar">
          <!-- Topo always on (button only for info, not toggled) -->
          <button class="layer-btn layer-topo" data-layer="topo" title="Topografya hep aÃ§Ä±k">ğŸ”ï¸ Topografya (Hep AÃ§Ä±k)</button>

          <!-- Others start OFF -->
          <button class="layer-btn layer-water off" data-layer="water">ğŸ’§ Su</button>
          <button class="layer-btn layer-roads off" data-layer="roads">ğŸ›£ï¸ UlaÅŸÄ±m</button>
          <button class="layer-btn layer-settle off" data-layer="settle">ğŸ˜ï¸ YerleÅŸim</button>
          <button class="layer-btn layer-risk off" data-layer="risk">âš ï¸ Risk</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn btn-green" id="centerTR">ğŸ‡¹ğŸ‡· TÃ¼rkiyeâ€™ye Ortala</button>
          <button class="btn" id="resetBtn">SÄ±fÄ±rla</button>
        </div>
      </div>

      <div style="margin-top:10px" class="note">
        Ä°stediÄŸin davranÄ±ÅŸ: Topografya hep aÃ§Ä±k. DiÄŸerleri kapalÄ± baÅŸlar.
        Butona basÄ±nca belirgin biÃ§imde aÃ§Ä±lÄ±r, tekrar basÄ±nca kapanÄ±r.
        Birden fazla katman aynÄ± anda aÃ§Ä±k kalabilir.
      </div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ® Kumanda KullanÄ±mÄ±</div>
      <div class="note">
        VR moddayken Ã§oÄŸu Bluetooth kumanda tarayÄ±cÄ±ya â€œklavyeâ€ gibi sinyal yollar:
        <b>Ok tuÅŸlarÄ±</b> = katman seÃ§, <b>Enter/Space</b> = aÃ§/kapat, <b>Esc</b> = VR kapat.
        AyrÄ±ca ekrandaki butonlara dokunarak da aÃ§Ä±p kapatabilirsin.
      </div>
    </div>
  </div>

  <!-- VR Overlay -->
  <div id="vrOverlay" aria-hidden="true">
    <div id="rotateHint">ğŸ“± VR iÃ§in telefonu <u>yatay</u> Ã§evir</div>

    <div class="vr-stage" id="vrStage">
      <div class="eye">
        <div class="map vr-3d" id="mapLeft"></div>
      </div>
      <div class="eye">
        <div class="map vr-3d" id="mapRight"></div>
      </div>

      <!-- HUD -->
      <div class="vr-hud" id="vrHud">
        <button class="layer-btn layer-topo" data-layer="topo" title="Topo hep aÃ§Ä±k">ğŸ”ï¸</button>
        <button class="layer-btn layer-water off" data-layer="water">ğŸ’§</button>
        <button class="layer-btn layer-roads off" data-layer="roads">ğŸ›£ï¸</button>
        <button class="layer-btn layer-settle off" data-layer="settle">ğŸ˜ï¸</button>
        <button class="layer-btn layer-risk off" data-layer="risk">âš ï¸</button>

        <button class="btn btn-warn" id="motionBtn">ğŸ› BaÅŸ Ä°zleme Ä°zni</button>
        <button class="btn btn-danger" id="vrCloseBtn">âœ– VR Kapat</button>
      </div>

      <div class="compass" id="compass">
        <div class="dir" id="compassDir">N</div>
        <div class="deg" id="compassDeg">0Â°</div>
      </div>

      <div class="vr-bottom">
        <button class="btn" id="zoomOut">â– Zoom</button>
        <button class="btn" id="zoomIn">â• Zoom</button>
        <button class="btn btn-green" id="centerTR2">ğŸ‡¹ğŸ‡· Ortala</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /*****************
     * Helpers
     *****************/
    const $ = (id)=>document.getElementById(id);

    function bindTap(el, fn){
      // iOS gÃ¼venilir tÄ±klama
      el.addEventListener("pointerdown", (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
      el.addEventListener("touchstart", (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
      el.addEventListener("click", (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
    }

    /*****************
     * State
     *****************/
    const state = {
      score:0,
      level:1,
      bep:false,

      // Topo always on
      layers:{
        topo:true,
        water:false,
        roads:false,
        settle:false,
        risk:false
      },

      vrOn:false,
      // VR kumanda seÃ§im sÄ±rasÄ± topo hariÃ§
      layerOrder:["water","roads","settle","risk"],
      activeIndex:0,

      // head tracking
      motionEnabled:false,
      headingDeg:0,
      lastTs:0
    };

    function addScore(p){
      state.score += p;
      const lv = Math.floor(state.score / 200) + 1;
      if(lv > state.level) state.level = lv;
      $("score").textContent = state.score;
      $("level").textContent = state.level;
    }

    /*****************
     * Map setup
     *****************/
    const trCenter = [39.0, 35.0];
    const trZoom = 6;

    // NORMAL MAP
    const mapNormal = L.map("mapNormal", { zoomControl:true, preferCanvas:true })
      .setView(trCenter, trZoom);

    // --- Base Topo tile (always on)
    const topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom:17,
      attribution:"Â© OpenTopoMap, Â© OpenStreetMap contributors",
      opacity: 1.0
    }).addTo(mapNormal);

    // ---- OVERLAYS (start OFF)
    // 1) Water overlay (more obvious)
    const waterLayerNormal = L.layerGroup();
    const waterLines = [
      // (Ã¶rnek) Karadeniz kÄ±yÄ± hattÄ±na yakÄ±n akÄ±ÅŸlar + Ä°Ã§ Anadolu Ã§izgisi
      [[41.2, 28.8],[41.3, 31.2],[41.1, 33.2],[41.1, 35.2],[41.2, 37.2]],
      [[39.9, 32.7],[39.4, 34.7],[38.9, 36.4],[37.9, 38.7],[37.0, 39.2]],
      [[38.7, 26.9],[38.8, 28.3],[38.6, 29.6],[38.3, 30.6]]
    ];
    waterLines.forEach(p => L.polyline(p, {color:"#1ea7ff", weight:5, opacity:.85}).addTo(waterLayerNormal));
    const lakes = [
      ["Van GÃ¶lÃ¼",38.6,42.9,40000],
      ["Tuz GÃ¶lÃ¼",38.8,33.3,35000],
      ["BeyÅŸehir",37.7,31.7,22000],
      ["EÄŸirdir",37.9,30.9,18000]
    ];
    lakes.forEach(([n,lat,lng,r])=>{
      L.circle([lat,lng],{radius:r,color:"#1ea7ff",fillColor:"#1ea7ff",fillOpacity:.25,weight:2})
        .bindTooltip("ğŸ’§ "+n).addTo(waterLayerNormal);
    });

    // 2) Roads overlay (more visible â€“ HOT style)
    const roadsTileNormal = L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", {
      maxZoom:19,
      attribution:"Â© OpenStreetMap contributors",
      opacity: 0.85
    });

    // 3) Settlement overlay (major cities)
    const settleLayerNormal = L.layerGroup();
    const cities = [
      ["Ä°stanbul",41.0082,28.9784],["Ankara",39.9334,32.8597],["Ä°zmir",38.4237,27.1428],
      ["Bursa",40.195,29.06],["Antalya",36.8969,30.7133],["Adana",37.0,35.3213],
      ["Gaziantep",37.0662,37.3833],["Konya",37.8715,32.4846],["Kayseri",38.7225,35.4875],
      ["Trabzon",41.0015,39.7178],["DiyarbakÄ±r",37.9144,40.2306],["Samsun",41.2867,36.33]
    ];
    cities.forEach(([n,lat,lng])=>{
      L.circleMarker([lat,lng],{
        radius:8,color:"#ffcc80",fillColor:"#ff6d00",fillOpacity:.85,weight:2
      }).bindTooltip("ğŸ˜ï¸ "+n).addTo(settleLayerNormal);
    });

    // 4) Risk overlay (example polygons)
    const riskLayerNormal = L.layerGroup();
    L.polygon([[41.35,28.65],[41.45,29.25],[41.20,29.35],[41.10,28.85]],
      {color:"#ff9800",fillColor:"#ff9800",fillOpacity:.25,weight:2}).bindTooltip("ğŸŸ  Sel riski (Ã¶rnek)").addTo(riskLayerNormal);
    L.polygon([[40.95,39.25],[41.20,39.95],[40.75,40.35],[40.55,39.70]],
      {color:"#ff1744",fillColor:"#ff1744",fillOpacity:.22,weight:2}).bindTooltip("ğŸ”´ Heyelan riski (Ã¶rnek)").addTo(riskLayerNormal);
    L.polygon([[38.7,26.3],[39.5,28.0],[38.6,29.2],[37.8,27.9]],
      {color:"#b71c1c",fillColor:"#b71c1c",fillOpacity:.18,weight:2}).bindTooltip("ğŸ”´ YÃ¼ksek risk (Ã¶rnek)").addTo(riskLayerNormal);

    function applyNormalLayers(){
      // topo always on
      // overlays: add/remove by state
      if(state.layers.water){ if(!mapNormal.hasLayer(waterLayerNormal)) waterLayerNormal.addTo(mapNormal); }
      else { if(mapNormal.hasLayer(waterLayerNormal)) mapNormal.removeLayer(waterLayerNormal); }

      if(state.layers.roads){ if(!mapNormal.hasLayer(roadsTileNormal)) roadsTileNormal.addTo(mapNormal); }
      else { if(mapNormal.hasLayer(roadsTileNormal)) mapNormal.removeLayer(roadsTileNormal); }

      if(state.layers.settle){ if(!mapNormal.hasLayer(settleLayerNormal)) settleLayerNormal.addTo(mapNormal); }
      else { if(mapNormal.hasLayer(settleLayerNormal)) mapNormal.removeLayer(settleLayerNormal); }

      if(state.layers.risk){ if(!mapNormal.hasLayer(riskLayerNormal)) riskLayerNormal.addTo(mapNormal); }
      else { if(mapNormal.hasLayer(riskLayerNormal)) mapNormal.removeLayer(riskLayerNormal); }
    }

    /*****************
     * Buttons state
     *****************/
    function setButtonStates(root){
      const scope = root || document;
      scope.querySelectorAll(".layer-btn[data-layer]").forEach(btn=>{
        const key = btn.dataset.layer;
        if(key === "topo"){
          btn.classList.remove("off");
          return;
        }
        btn.classList.toggle("off", !state.layers[key]);
      });

      // VR kumanda seÃ§imi gÃ¶rÃ¼nÃ¼r olsun
      if(root === $("vrHud")){
        const keys = state.layerOrder;
        scope.querySelectorAll(".layer-btn[data-layer]").forEach(btn=>{
          const k = btn.dataset.layer;
          if(keys.includes(k)){
            const idx = keys.indexOf(k);
            btn.style.outline = (idx === state.activeIndex) ? "3px solid rgba(255,255,255,.85)" : "none";
          }else{
            btn.style.outline = "none";
          }
        });
      }
    }

    function toggleLayer(key){
      if(key === "topo"){
        // topo always on - do nothing
        addScore(1);
        return;
      }
      state.layers[key] = !state.layers[key];
      applyNormalLayers();
      if(mapLeft && mapRight){
        applyVRLayers();
      }
      setButtonStates(document);
      if($("vrHud")) setButtonStates($("vrHud"));
      addScore(5);
    }

    /*****************
     * Bind normal controls
     *****************/
    document.querySelectorAll("#layerBar .layer-btn[data-layer]").forEach(btn=>{
      bindTap(btn, ()=>toggleLayer(btn.dataset.layer));
    });

    bindTap($("centerTR"), ()=>{
      mapNormal.setView(trCenter, trZoom, {animate:true});
      addScore(2);
    });

    bindTap($("resetBtn"), ()=>{
      state.layers.water=false; state.layers.roads=false; state.layers.settle=false; state.layers.risk=false;
      applyNormalLayers();
      setButtonStates(document);
      if($("vrHud")) setButtonStates($("vrHud"));
      addScore(1);
    });

    /*****************
     * BEP
     *****************/
    bindTap($("bepBtn"), ()=>{
      state.bep = !state.bep;
      document.body.style.fontSize = state.bep ? "18px" : "";
      $("bepBtn").textContent = state.bep ? "Normal Mod" : "BEP Modu";
      addScore(2);
    });

    /*****************
     * VR MODE
     *****************/
    let mapLeft=null, mapRight=null;
    let topoLeft=null, topoRight=null;
    let waterLeft=null, waterRight=null;
    let roadsLeft=null, roadsRight=null;
    let settleLeft=null, settleRight=null;
    let riskLeft=null, riskRight=null;

    function isLandscape(){
      return window.matchMedia("(orientation: landscape)").matches;
    }
    function updateRotateHint(){
      $("rotateHint").classList.toggle("on", state.vrOn && !isLandscape());
    }

    function buildOverlayFor(map){
      const water = L.layerGroup();
      waterLines.forEach(p => L.polyline(p, {color:"#1ea7ff", weight:5, opacity:.85}).addTo(water));
      lakes.forEach(([n,lat,lng,r])=>{
        L.circle([lat,lng],{radius:r,color:"#1ea7ff",fillColor:"#1ea7ff",fillOpacity:.25,weight:2})
          .bindTooltip("ğŸ’§ "+n).addTo(water);
      });

      const settle = L.layerGroup();
      cities.forEach(([n,lat,lng])=>{
        L.circleMarker([lat,lng],{
          radius:8,color:"#ffcc80",fillColor:"#ff6d00",fillOpacity:.85,weight:2
        }).bindTooltip("ğŸ˜ï¸ "+n).addTo(settle);
      });

      const risk = L.layerGroup();
      L.polygon([[41.35,28.65],[41.45,29.25],[41.20,29.35],[41.10,28.85]],
        {color:"#ff9800",fillColor:"#ff9800",fillOpacity:.25,weight:2}).addTo(risk);
      L.polygon([[40.95,39.25],[41.20,39.95],[40.75,40.35],[40.55,39.70]],
        {color:"#ff1744",fillColor:"#ff1744",fillOpacity:.22,weight:2}).addTo(risk);
      L.polygon([[38.7,26.3],[39.5,28.0],[38.6,29.2],[37.8,27.9]],
        {color:"#b71c1c",fillColor:"#b71c1c",fillOpacity:.18,weight:2}).addTo(risk);

      return { water, settle, risk };
    }

    function applyVRLayers(){
      // topo always on (already added)
      function apply(map, water, roads, settle, risk){
        if(state.layers.water){ if(!map.hasLayer(water)) water.addTo(map); } else { if(map.hasLayer(water)) map.removeLayer(water); }
        if(state.layers.roads){ if(!map.hasLayer(roads)) roads.addTo(map); } else { if(map.hasLayer(roads)) map.removeLayer(roads); }
        if(state.layers.settle){ if(!map.hasLayer(settle)) settle.addTo(map); } else { if(map.hasLayer(settle)) map.removeLayer(settle); }
        if(state.layers.risk){ if(!map.hasLayer(risk)) risk.addTo(map); } else { if(map.hasLayer(risk)) map.removeLayer(risk); }
      }
      apply(mapLeft,  waterLeft,  roadsLeft,  settleLeft,  riskLeft);
      apply(mapRight, waterRight, roadsRight, settleRight, riskRight);
    }

    function syncMaps(a,b){
      let lock=false;
      a.on("move", ()=>{
        if(lock) return;
        lock=true;
        b.setView(a.getCenter(), a.getZoom(), {animate:false});
        lock=false;
      });
    }

    function enterVR(){
      state.vrOn = true;
      $("vrOverlay").classList.add("on");
      document.body.classList.add("vr-lock");
      updateRotateHint();

      if(!mapLeft){
        // create maps once
        mapLeft = L.map("mapLeft", { zoomControl:false, attributionControl:false, preferCanvas:true })
          .setView(mapNormal.getCenter(), mapNormal.getZoom());

        mapRight = L.map("mapRight", { zoomControl:false, attributionControl:false, preferCanvas:true })
          .setView(mapNormal.getCenter(), mapNormal.getZoom());

        topoLeft = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", { maxZoom:17, opacity:1.0 }).addTo(mapLeft);
        topoRight= L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", { maxZoom:17, opacity:1.0 }).addTo(mapRight);

        // overlays
        const oL = buildOverlayFor(mapLeft);
        const oR = buildOverlayFor(mapRight);

        waterLeft = oL.water; settleLeft=oL.settle; riskLeft=oL.risk;
        waterRight= oR.water; settleRight=oR.settle; riskRight=oR.risk;

        roadsLeft = L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", { maxZoom:19, opacity:0.85 });
        roadsRight= L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", { maxZoom:19, opacity:0.85 });

        applyVRLayers();

        syncMaps(mapLeft, mapRight);
        syncMaps(mapRight, mapLeft);
      }

      // resize + sync view with normal
      setTimeout(()=>{
        mapLeft.invalidateSize(); mapRight.invalidateSize();
        mapLeft.setView(mapNormal.getCenter(), mapNormal.getZoom(), {animate:false});
        mapRight.setView(mapNormal.getCenter(), mapNormal.getZoom(), {animate:false});
      }, 60);

      // bind VR HUD buttons once
      $("vrHud").querySelectorAll(".layer-btn[data-layer]").forEach(btn=>{
        if(btn.dataset.bound) return;
        btn.dataset.bound = "1";
        bindTap(btn, ()=>toggleLayer(btn.dataset.layer));
      });

      // VR controls
      bindTap($("vrCloseBtn"), exitVR);
      bindTap($("zoomIn"), ()=>{ mapLeft.zoomIn(); addScore(1); });
      bindTap($("zoomOut"), ()=>{ mapLeft.zoomOut(); addScore(1); });
      bindTap($("centerTR2"), ()=>{
        mapLeft.setView(trCenter, trZoom, {animate:true});
        addScore(2);
      });
      bindTap($("motionBtn"), requestMotion);

      setButtonStates(document);
      setButtonStates($("vrHud"));
      addScore(10);
    }

    function exitVR(){
      state.vrOn = false;
      $("vrOverlay").classList.remove("on");
      document.body.classList.remove("vr-lock");
      updateRotateHint();
      state.motionEnabled = false;
      $("motionBtn").textContent = "ğŸ› BaÅŸ Ä°zleme Ä°zni";
      addScore(5);
    }

    bindTap($("vrBtn"), enterVR);

    window.addEventListener("resize", ()=>{
      if(state.vrOn){
        updateRotateHint();
        if(mapLeft){ mapLeft.invalidateSize(); mapRight.invalidateSize(); }
      }
    }, {passive:true});

    window.addEventListener("orientationchange", ()=>{
      if(state.vrOn){
        setTimeout(()=>{
          updateRotateHint();
          if(mapLeft){ mapLeft.invalidateSize(); mapRight.invalidateSize(); }
        }, 250);
      }
    });

    /*****************
     * Head tracking (best effort)
     *****************/
    async function requestMotion(){
      try{
        if(typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function"){
          const res = await DeviceOrientationEvent.requestPermission();
          if(res !== "granted") throw new Error("Ä°zin verilmedi");
        }
        state.motionEnabled = true;
        $("motionBtn").textContent = "âœ… BaÅŸ Ä°zleme AÃ§Ä±k";
        addScore(5);
      }catch(e){
        alert("BaÅŸ izleme iÃ§in iOS izin vermedi.\nAyarlar > Safari > Hareket & YÃ¶n eriÅŸimini kontrol et.\n\nDetay: " + e.message);
      }
    }

    function headingToDir(deg){
      const dirs = ["N","NE","E","SE","S","SW","W","NW"];
      const idx = Math.round(((deg%360)+360)%360 / 45) % 8;
      return dirs[idx];
    }

    // â€œkafayÄ± Ã§evirince haritada dÃ¶nelimâ€ hissi iÃ§in:
    // 1) mapâ€™i hafif pan ediyoruz
    // 2) gÃ¶z containerâ€™Ä± Ã§ok kÃ¼Ã§Ã¼k rotasyonla dÃ¶nÃ¼yor (tam harita rotasyonu deÄŸil ama hissi gÃ¼Ã§lendirir)
    window.addEventListener("deviceorientation", (e)=>{
      if(!state.vrOn || !state.motionEnabled || !mapLeft) return;

      const now = performance.now();
      if(now - state.lastTs < 40) return; // throttle
      state.lastTs = now;

      const alpha = (e.alpha ?? 0); // 0..360
      const beta  = (e.beta ?? 0);  // -180..180

      // heading
      const heading = ((alpha % 360) + 360) % 360;
      state.headingDeg = heading;

      $("compassDeg").textContent = Math.round(heading) + "Â°";
      $("compassDir").textContent = headingToDir(heading);

      // pan based on yaw (alpha) and pitch (beta)
      const yaw = ((heading + 540) % 360) - 180; // -180..180
      const pitch = Math.max(-35, Math.min(35, beta));

      const z = mapLeft.getZoom();
      const scale = 0.0009 * Math.pow(2, (7 - z));

      const dx = yaw * scale;
      const dy = pitch * scale;

      const c = mapLeft.getCenter();
      const next = L.latLng(c.lat + (-dy), c.lng + (dx));
      mapLeft.panTo(next, {animate:false});

      // tiny rotation effect (visual)
      const rot = Math.max(-8, Math.min(8, yaw / 18));
      $("mapLeft").style.transform = `rotate(${rot}deg)`;
      $("mapRight").style.transform = `rotate(${rot}deg)`;
    }, {passive:true});

    /*****************
     * Bluetooth kumanda / klavye
     *****************/
    function selectDelta(d){
      const n = state.layerOrder.length;
      state.activeIndex = (state.activeIndex + d + n) % n;
      setButtonStates($("vrHud"));
    }

    document.addEventListener("keydown", (e)=>{
      if(!state.vrOn) return;

      if(e.key === "ArrowLeft" || e.key === "ArrowUp"){
        e.preventDefault();
        selectDelta(-1);
      }else if(e.key === "ArrowRight" || e.key === "ArrowDown"){
        e.preventDefault();
        selectDelta(+1);
      }else if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        const key = state.layerOrder[state.activeIndex];
        toggleLayer(key);
      }else if(e.key.toLowerCase() === "escape"){
        e.preventDefault();
        exitVR();
      }
    }, {passive:false});

    /*****************
     * Init
     *****************/
    applyNormalLayers();
    setButtonStates(document);
    addScore(0);
  </script>
</body>
</html>
