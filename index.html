<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>HaritaG√∂z - iOS Uyumlu Katman + VR (Tek HTML)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#1a2a3a 0%,#2d4a5c 100%);
      color:#fff;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
    }

    .header{
      background:rgba(0,0,0,.3);
      padding:16px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      backdrop-filter:blur(10px);
      border-bottom:2px solid rgba(76,175,80,.3);
      gap:12px;
      position:sticky;top:0;z-index:50;
    }
    .logo{font-size:24px;font-weight:800;color:#4CAF50;display:flex;align-items:center;gap:10px}
    .stats{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .stat-item{text-align:center;min-width:70px}
    .stat-value{font-size:20px;font-weight:800;color:#FFC107}
    .stat-label{font-size:12px;color:#B0BEC5}

    .bep-toggle,.vr-toggle{
      color:white;border:none;padding:10px 12px;border-radius:18px;
      cursor:pointer;font-size:14px;font-weight:800;transition:.2s;white-space:nowrap;
      -webkit-tap-highlight-color:transparent;touch-action:manipulation;
    }
    .bep-toggle{background:#2196F3}
    .bep-toggle.active{background:#FF9800}
    .vr-toggle{background:linear-gradient(135deg,#4CAF50,#8BC34A)}
    .vr-toggle.active{background:linear-gradient(135deg,#f44336,#ff5252)}

    .container{max-width:1400px;margin:0 auto;padding:22px 14px}
    .section{
      background:rgba(255,255,255,.05);
      border-radius:18px;
      padding:18px;
      margin-bottom:18px;
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.1);
    }
    .section-title{font-size:22px;margin-bottom:14px;color:#4CAF50;display:flex;align-items:center;gap:10px}

    .task-prompt{
      background:rgba(255,193,7,.18);
      border:2px solid #FFC107;
      padding:14px;border-radius:14px;margin-bottom:14px;
    }
    .task-prompt-title{font-size:18px;font-weight:900;color:#FFC107;margin-bottom:8px}
    .task-prompt-desc{font-size:15px;color:#E0E0E0;line-height:1.35}

    .ar-simulator{
      background:#121212;border-radius:16px;padding:14px;position:relative;
      border:3px solid #4CAF50;overflow:hidden;
    }

    .ar-viewport{
      position:relative;width:100%;
      height:55vh; min-height:360px; max-height:520px;
      background:#0b1218;border-radius:12px;overflow:hidden;
    }
    #mapNormal{width:100%;height:100%}

    .ar-info-point{
      position:absolute;z-index:20;
      background:rgba(76,175,80,.92);color:#fff;
      padding:10px 12px;border-radius:10px;font-size:14px;font-weight:900;
      box-shadow:0 4px 10px rgba(0,0,0,.3);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      user-select:none;
    }

    .layer-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .layer-btn{
      padding:12px 14px;border:none;border-radius:12px;cursor:pointer;
      font-size:14px;font-weight:900;transition:all .15s;
      display:flex;align-items:center;gap:8px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      user-select:none;
    }
    .layer-btn.inactive{opacity:.45;filter:grayscale(100%)}
    .layer-btn.topography{background:linear-gradient(135deg,#8B4513,#D2691E);color:#fff}
    .layer-btn.roads{background:linear-gradient(135deg,#FFD700,#FFA500);color:#222}
    .layer-btn.water{background:linear-gradient(135deg,#1E90FF,#4169E1);color:#fff}
    .layer-btn.settlement{background:linear-gradient(135deg,#FF6347,#FF8C00);color:#fff}
    .layer-btn.risk{background:linear-gradient(135deg,#DC143C,#8B0000);color:#fff}

    .direction-controls{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:10px;max-width:220px;margin:14px auto 0;
    }
    .direction-btn{
      padding:14px;background:#2196F3;border:none;border-radius:12px;color:#fff;
      cursor:pointer;font-size:18px;font-weight:900;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      user-select:none;
    }
    .direction-btn:nth-child(2){grid-column:2}
    .direction-btn:nth-child(4){grid-column:1}
    .direction-btn:nth-child(5){grid-column:3}
    .direction-btn:nth-child(6){grid-column:2}

    .missions{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:14px}
    .mission-card{
      background:linear-gradient(135deg,rgba(33,150,243,.2),rgba(76,175,80,.2));
      padding:14px;border-radius:14px;border:2px solid rgba(255,255,255,.2);
      cursor:pointer;position:relative;
    }
    .mission-card.completed{border-color:#4CAF50}
    .mission-card.active{border-color:#FFC107}
    .mission-title{font-size:16px;font-weight:900;margin-bottom:8px;color:#4CAF50}
    .mission-desc{font-size:13px;color:#CFD8DC;margin-bottom:10px;line-height:1.25}
    .mission-reward{font-size:14px;color:#FFC107;font-weight:900}
    .mission-status{
      position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;font-size:16px
    }
    .mission-status.locked{background:#757575}
    .mission-status.active{background:#FFC107}
    .mission-status.completed{background:#4CAF50}

    .achievements{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-top:14px}
    .achievement{
      background:rgba(255,255,255,.05);padding:14px;border-radius:14px;text-align:center;
      border:2px solid rgba(255,255,255,.1)
    }
    .achievement.unlocked{border-color:#FFC107;background:rgba(255,193,7,.1)}
    .achievement-icon{font-size:44px;margin-bottom:8px;filter:grayscale(100%)}
    .achievement.unlocked .achievement-icon{filter:grayscale(0%)}
    .achievement-name{font-size:13px;font-weight:900;margin-bottom:4px}
    .achievement-desc{font-size:11px;color:#B0BEC5}

    .quiz{margin-top:14px}
    .quiz-question{background:rgba(255,255,255,.05);padding:14px;border-radius:14px;margin-bottom:12px}
    .quiz-question-text{font-size:15px;margin-bottom:10px;color:#E0E0E0;line-height:1.25}
    .quiz-options{display:flex;flex-direction:column;gap:10px}
    .quiz-option{
      padding:14px;background:rgba(255,255,255,.1);border:2px solid transparent;border-radius:12px;
      cursor:pointer;transition:.15s;font-weight:800;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      user-select:none;
    }
    .quiz-option.selected{border-color:#FFC107;background:rgba(255,193,7,.2)}
    .quiz-option.correct{border-color:#4CAF50;background:rgba(76,175,80,.2)}
    .quiz-option.wrong{border-color:#F44336;background:rgba(244,67,54,.2)}

    .btn-primary{
      background:linear-gradient(135deg,#4CAF50,#8BC34A);
      color:white;border:none;padding:14px 18px;border-radius:20px;
      font-size:15px;font-weight:900;cursor:pointer;transition:.15s;display:inline-block;margin-top:10px;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
    }
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}

    .result-panel{
      background:linear-gradient(135deg,rgba(76,175,80,.2),rgba(33,150,243,.2));
      padding:18px;border-radius:14px;text-align:center;margin-top:12px;border:2px solid #4CAF50;
    }
    .result-score{font-size:40px;font-weight:900;color:#FFC107;margin-bottom:8px}
    .result-message{font-size:18px;color:#E0E0E0;margin-bottom:10px}
    .hidden{display:none}

    /* BEP */
    body.bep-mode{font-size:18px}
    body.bep-mode .section-title{font-size:28px}
    body.bep-mode .layer-btn,body.bep-mode .direction-btn,body.bep-mode .quiz-option{font-size:18px;padding:18px}

    /* VR */
    body.vr-lock{
      overflow:hidden;
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      touch-action:none;
    }
    #vrOverlay{
      position:fixed;inset:0;z-index:9999;background:#000;display:none;
    }
    #vrOverlay.on{display:block}
    .vr-stage{position:absolute;inset:0;display:flex;width:100%;height:100%}
  .eye{
  position:relative;
  width:50%;
  height:100%;
  overflow:hidden;
  background:#000;

  /* D√úZ split-screen: yuvarlaklƒ±k yok */
  border-radius: 0;
  margin: 0;

  outline: none;
  box-shadow: none;
}

/* Lens parlama + cam efekti */
.eye::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index: 3002;
  opacity:.65;
  background:
    radial-gradient(circle at 30% 25%,
      rgba(255,255,255,.18) 0%,
      rgba(255,255,255,0) 40%),
    radial-gradient(circle at 70% 70%,
      rgba(255,255,255,.08) 0%,
      rgba(255,255,255,0) 45%);
}

/* Harita: merkez net, kenar hafif bozulmu≈ü gibi */
.eye .leaflet-container{
  transform: scale(1.10);
  transform-origin: center;
  filter: contrast(1.10) saturate(1.12);
}

/* Kenarlara blur vererek barrel hissine yakla≈ü (ger√ßek distortion deƒüil ama VR hissi artƒ±rƒ±r) */
.eye .map{
  position:absolute; inset:0;
}
.eye .map::before{
  content:"";
  position:absolute;
  inset:-6%;
  pointer-events:none;
  z-index: 2500;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,0) 55%,
      rgba(0,0,0,.10) 72%,
      rgba(0,0,0,.30) 88%,
      rgba(0,0,0,.55) 100%);
  backdrop-filter: blur(0.6px);
  -webkit-backdrop-filter: blur(0.6px);
}


    .eye .map{position:absolute;inset:0;width:100%;height:100%}
    #mapLeft,#mapRight{width:100%;height:100%}

    .vr-hud{
      position:absolute;
      top: env(safe-area-inset-top, 10px);
      left:0;right:0;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:center;
      padding:12px;
      z-index:2000;
      pointer-events:auto;
    }
    .vr-hud *{pointer-events:auto}

    .vr-bottom{
      position:absolute;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
      left:0;right:0;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:center;
      padding:0 10px 12px;
      z-index:2000;
      pointer-events:auto;
    }
    .vr-btn{
      border:none;border-radius:14px;padding:12px 14px;
      font-weight:900;cursor:pointer;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      user-select:none;
    }
    .vr-btn.danger{background:linear-gradient(135deg,#f44336,#ff5252);border:none}
    .vr-btn.warn{background:linear-gradient(135deg,#ff9800,#ffb300);border:none;color:#222}
    .vr-btn.good{background:linear-gradient(135deg,#4CAF50,#8BC34A);border:none}

    .reticle{
      position:absolute;left:50%;top:50%;
      width:18px;height:18px;
      transform:translate(-50%,-50%);
      border:2px solid rgba(255,255,255,.85);
      border-radius:50%;
      z-index:2100;
      pointer-events:none;
      box-shadow:0 0 10px rgba(255,255,255,.35);
    }

    .compass{
      position:absolute;
      right:12px;
      top: calc(env(safe-area-inset-top, 10px) + 12px);
      z-index:2200;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.22);
      padding:10px 12px;border-radius:14px;
      min-width:120px;text-align:center;
      pointer-events:none;
    }
    .compass .dir{font-weight:900;color:#fff;font-size:14px}
    .compass .deg{font-size:12px;color:rgba(255,255,255,.82)}

    #rotateHint{
      display:none;
      position:absolute;inset:0;z-index:3000;
      background:rgba(0,0,0,.88);
      align-items:center;justify-content:center;
      padding:20px;text-align:center;
      font-weight:900;font-size:18px;
    }
    #rotateHint.on{display:flex}

    /* Debug panel */
    #debug{
      position:fixed;
      left:10px;
      bottom:10px;
      z-index:10000;
      width:min(92vw, 380px);
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.2);
      border-radius:12px;
      padding:10px;
      font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
      line-height:1.3;
      color:#d7ffd7;
    }
    #debug b{color:#fff}
    #debug .row{margin-top:6px;color:#bfe9ff}
    #debug .err{margin-top:6px;color:#ffb4b4}

    .leaflet-control-attribution{font-size:10px}
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">üó∫Ô∏è HaritaG√∂z</div>
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Puan</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="level">1</div>
        <div class="stat-label">Seviye</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="missions-completed">0/8</div>
        <div class="stat-label">G√∂rev</div>
      </div>
      <button class="bep-toggle" id="bep-toggle">BEP Modu</button>
      <button class="vr-toggle" id="vr-toggle">ü•Ω VR Modu</button>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <div class="section-title">üéØ Harita Sim√ºlat√∂r√º</div>

      <div class="task-prompt" id="current-task">
        <div class="task-prompt-title">Hazƒ±r ‚úÖ</div>
        <div class="task-prompt-desc">
          Topografya (y√ºkselti) her zaman a√ßƒ±k. Diƒüer katmanlar butonla a√ß/kapat olur.
          A√áIK bir katmana tekrar basarsan kapanƒ±r. √úst √ºste a√ßabilirsin.
        </div>
      </div>

      <div class="ar-simulator">
        <div class="ar-viewport" id="ar-viewport">
          <div id="mapNormal"></div>

          <div class="ar-info-point" style="top: 12%; left: 10%;" data-info="topography">üìä Topo</div>
          <div class="ar-info-point" style="top: 70%; left: 60%;" data-info="risk">‚ö†Ô∏è Risk</div>
          <div class="ar-info-point" style="top: 40%; left: 70%;" data-info="water">üíß Su</div>
        </div>

        <div class="layer-controls">
          <button class="layer-btn topography" data-layer="topography">üèîÔ∏è Topografya (Hep A√ßƒ±k)</button>
          <button class="layer-btn roads inactive" data-layer="roads">üõ£Ô∏è Ula≈üƒ±m</button>
          <button class="layer-btn water inactive" data-layer="water">üíß Su</button>
          <button class="layer-btn settlement inactive" data-layer="settlement">üèòÔ∏è Yerle≈üim</button>
          <button class="layer-btn risk inactive" data-layer="risk">‚ö†Ô∏è Risk</button>
        </div>

        <div class="direction-controls">
          <button class="direction-btn" data-direction="nw">‚ÜñÔ∏è</button>
          <button class="direction-btn" data-direction="n">‚¨ÜÔ∏è</button>
          <button class="direction-btn" data-direction="ne">‚ÜóÔ∏è</button>
          <button class="direction-btn" data-direction="w">‚¨ÖÔ∏è</button>
          <button class="direction-btn" data-direction="e">‚û°Ô∏è</button>
          <button class="direction-btn" data-direction="sw">‚ÜôÔ∏è</button>
          <button class="direction-btn" data-direction="s">‚¨áÔ∏è</button>
          <button class="direction-btn" data-direction="se">‚ÜòÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üéØ G√∂revler</div>
      <div class="missions" id="missions"></div>
    </div>

    <div class="section">
      <div class="section-title">üèÜ Ba≈üarƒ±mlar</div>
      <div class="achievements" id="achievements"></div>
    </div>

    <div class="section" id="quiz-section">
      <div class="section-title">üìù Harita Okuryazarlƒ±ƒüƒ± Testi</div>
      <div class="quiz" id="quiz"></div>
      <button class="btn-primary" id="check-answers">Cevaplarƒ± Kontrol Et</button>
      <div class="result-panel hidden" id="quiz-result">
        <div class="result-score" id="quiz-score"></div>
        <div class="result-message" id="quiz-message"></div>
      </div>
    </div>
  </div>

  <!-- VR Overlay -->
  <div id="vrOverlay" aria-hidden="true">
    <div id="rotateHint">üì± VR i√ßin telefonu <u>yatay</u> √ßevir</div>

    <div class="vr-stage">
      <div class="eye"><div class="map" id="mapLeft"></div></div>
      <div class="eye"><div class="map" id="mapRight"></div></div>

      <div class="reticle"></div>

      <div class="vr-hud" id="vrHud">
        <button class="layer-btn topography" data-layer="topography" title="Topo hep a√ßƒ±k">üèîÔ∏è</button>
        <button class="layer-btn roads inactive" data-layer="roads">üõ£Ô∏è</button>
        <button class="layer-btn water inactive" data-layer="water">üíß</button>
        <button class="layer-btn settlement inactive" data-layer="settlement">üèòÔ∏è</button>
        <button class="layer-btn risk inactive" data-layer="risk">‚ö†Ô∏è</button>

        <button class="vr-btn warn" id="motionBtn">üéõ Ba≈ü ƒ∞zleme ƒ∞zni</button>
        <button class="vr-btn danger" id="vrCloseBtn">‚úñ VR Kapat</button>
      </div>

      <div class="compass">
        <div class="dir" id="compassDir">N</div>
        <div class="deg" id="compassDeg">0¬∞</div>
      </div>

      <div class="vr-bottom">
        <button class="vr-btn" id="zoomOut">‚ûñ Zoom</button>
        <button class="vr-btn" id="zoomIn">‚ûï Zoom</button>
        <button class="vr-btn good" id="centerTR">üáπüá∑ Ortala</button>
      </div>
    </div>
  </div>

  <!-- Debug -->
  <div id="debug">
    <b>DEBUG</b>
    <div class="row" id="dbg1">Ba≈ülatƒ±lƒ±yor‚Ä¶</div>
    <div class="row" id="dbg2"></div>
    <div class="err" id="dbgE"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /***********************
     * DEBUG helpers
     ***********************/
    const dbg1 = document.getElementById("dbg1");
    const dbg2 = document.getElementById("dbg2");
    const dbgE = document.getElementById("dbgE");
    function log1(s){ dbg1.textContent = s; }
    function log2(s){ dbg2.textContent = s; }
    function logE(s){ dbgE.textContent = "ERROR: " + s; }

    window.addEventListener("error", (e)=>{
      logE((e && e.message) ? e.message : "unknown error");
    });

    /***********************
     * iOS-safe single-tap binder
     * (NO touchstart/pointerdown to avoid double toggle)
     ***********************/
    function bindTap(el, fn){
      let last = 0;
      el.addEventListener("click", (e)=>{
        const now = Date.now();
        if (now - last < 350) return;
        last = now;
        try { e.preventDefault(); } catch(_) {}
        fn(e);
      }, {passive:false});
    }

    /***********************
     * Game State
     ***********************/
    const gameState = {
      score: 0,
      level: 1,
      completedMissions: 0,
      activeLayers: ['topography'],
      bepMode: false,
      directionsSet: new Set(),
      riskPointClicked:false,
      waterPointClicked:false,
      roadsExplored:false,
      quizCompleted:false,
      layersUsed:new Set(['topography'])
    };

    const missions = [
      { id:1,title:'Katmanlarƒ± Ke≈üfet',desc:'Su, ula≈üƒ±m, yerle≈üim ve risk katmanlarƒ±nƒ± en az bir kez a√ß',reward:50,status:'active',
        check:()=>['water','roads','settlement','risk'].every(k=>gameState.layersUsed.has(k)) },
      { id:2,title:'Y√∂n Bul',desc:'En az 4 farklƒ± y√∂ne ilerle',reward:75,status:'locked',
        check:()=>gameState.directionsSet.size>=4 },
      { id:3,title:'Risk Analizi',desc:'Risk katmanƒ±nƒ± a√ß ve risk noktasƒ±nƒ± ke≈üfet',reward:100,status:'locked',
        check:()=>gameState.activeLayers.includes('risk') && gameState.riskPointClicked },
      { id:4,title:'Su Kaynaklarƒ±',desc:'Su katmanƒ±nƒ± a√ß ve su noktasƒ±nƒ± ke≈üfet',reward:100,status:'locked',
        check:()=>gameState.activeLayers.includes('water') && gameState.waterPointClicked },
      { id:5,title:'G√ºzergah Planlama',desc:'Ula≈üƒ±m katmanƒ±nƒ± a√ß ve haritada gezin',reward:150,status:'locked',
        check:()=>gameState.activeLayers.includes('roads') && gameState.roadsExplored },
      { id:6,title:'Yerle≈üim Analizi',desc:'Yerle≈üim katmanƒ±nƒ± a√ß ve ≈üehirleri incele',reward:150,status:'locked',
        check:()=>gameState.activeLayers.includes('settlement') },
      { id:7,title:'Harita Uzmanƒ±',desc:'Testi tamamla',reward:200,status:'locked',
        check:()=>gameState.quizCompleted },
      { id:8,title:'AR Ustasƒ±',desc:'T√ºm g√∂revleri tamamla ve 1000 puana ula≈ü',reward:300,status:'locked',
        check:()=>gameState.completedMissions>=7 && gameState.score>=1000 }
    ];

    const achievements = [
      { id:1, icon:'üó∫Ô∏è', name:'ƒ∞lk Ke≈üif', desc:'ƒ∞lk ek katmanƒ± a√ßtƒ±n', unlocked:false },
      { id:2, icon:'üß≠', name:'Y√∂n Bulma', desc:'4 farklƒ± y√∂ne ilerledin', unlocked:false },
      { id:3, icon:'‚ö†Ô∏è', name:'Risk Farkƒ±ndalƒ±ƒüƒ±', desc:'Risk noktasƒ±nƒ± ke≈üfettin', unlocked:false },
      { id:4, icon:'üíß', name:'Su Ka≈üifi', desc:'Su noktasƒ±nƒ± ke≈üfettin', unlocked:false },
      { id:5, icon:'üèÜ', name:'ƒ∞lk G√∂rev', desc:'ƒ∞lk g√∂revi tamamladƒ±n', unlocked:false },
      { id:6, icon:'üìö', name:'Bilgi Avcƒ±sƒ±', desc:'500 puana ula≈ütƒ±n', unlocked:false },
      { id:7, icon:'üéì', name:'Harita Uzmanƒ±', desc:'Testi ge√ßtin', unlocked:false },
      { id:8, icon:'üëë', name:'AR Ustasƒ±', desc:'T√ºm g√∂revleri tamamladƒ±n', unlocked:false }
    ];

    const quizQuestions = [
      { question:'Haritada y√ºksekliƒüi g√∂steren katman hangisidir?', options:['Topografya','Ula≈üƒ±m','Yerle≈üim','Risk'], correct:0 },
      { question:'Sel riski analizi i√ßin hangi katmanlar birlikte kullanƒ±lmalƒ±dƒ±r?', options:['Sadece risk','Su + topografya','Sadece yerle≈üim','Sadece ula≈üƒ±m'], correct:1 },
      { question:'N√ºfus yoƒüunluƒüunu anlamak i√ßin hangi katman?', options:['Topografya','Su','Yerle≈üim','Ula≈üƒ±m'], correct:2 },
      { question:'Yaya i√ßin g√ºvenli g√ºzergah planlarken hangi katmanlar √∂nemlidir?', options:['Ula≈üƒ±m + risk','Sadece topografya','Sadece su','Sadece yerle≈üim'], correct:0 },
      { question:'AR harita uygulamalarƒ±nƒ±n avantajƒ± nedir?', options:['Daha pahalƒ±dƒ±r','Ger√ßek √ßevre ile harita birle≈üir','Sadece sƒ±nƒ±fta','Tek katman'], correct:1 }
    ];

    function updateTaskPrompt(title,desc){
      document.querySelector("#current-task .task-prompt-title").textContent=title;
      document.querySelector("#current-task .task-prompt-desc").textContent=desc;
    }

    function renderMissions(){
      const c=document.getElementById('missions');
      c.innerHTML=missions.map(m=>`
        <div class="mission-card ${m.status}">
          <div class="mission-status ${m.status}">${m.status==='locked'?'üîí':m.status==='active'?'‚ö°':'‚úÖ'}</div>
          <div class="mission-title">${m.title}</div>
          <div class="mission-desc">${m.desc}</div>
          <div class="mission-reward">+${m.reward} Puan</div>
        </div>
      `).join('');
    }
    function renderAchievements(){
      const c=document.getElementById('achievements');
      c.innerHTML=achievements.map(a=>`
        <div class="achievement ${a.unlocked?'unlocked':''}">
          <div class="achievement-icon">${a.icon}</div>
          <div class="achievement-name">${a.name}</div>
          <div class="achievement-desc">${a.desc}</div>
        </div>
      `).join('');
    }
    function renderQuiz(){
      const c=document.getElementById('quiz');
      c.innerHTML=quizQuestions.map((q,i)=>`
        <div class="quiz-question" data-question="${i}">
          <div class="quiz-question-text">${i+1}. ${q.question}</div>
          <div class="quiz-options">
            ${q.options.map((opt,j)=>`<div class="quiz-option" data-question="${i}" data-option="${j}">${opt}</div>`).join('')}
          </div>
        </div>
      `).join('');
    }

    function updateStats(){
      document.getElementById('score').textContent=gameState.score;
      document.getElementById('level').textContent=gameState.level;
      document.getElementById('missions-completed').textContent=`${gameState.completedMissions}/${missions.length}`;
    }

    function addScore(p){
      gameState.score+=p;
      const nl=Math.floor(gameState.score/200)+1;
      if(nl>gameState.level) gameState.level=nl;
      updateStats();
    }
    function unlockAchievement(id){
      const a=achievements.find(x=>x.id===id);
      if(a && !a.unlocked){
        a.unlocked=true;
        renderAchievements();
        addScore(50);
      }
    }

    function completeMission(i){
      const m=missions[i];
      if(m.status!=='completed'){
        m.status='completed';
        gameState.completedMissions++;
        addScore(m.reward);
        if(gameState.completedMissions===1) unlockAchievement(5);
        if(i<missions.length-1) missions[i+1].status='active';
        renderMissions();
        updateStats();
      }
    }
    function checkMissions(){
      missions.forEach((m,i)=>{
        if(m.status==='active' && m.check()) completeMission(i);
        else if(m.status==='locked' && i>0 && missions[i-1].status==='completed') m.status='active';
      });
      renderMissions();
    }

    function selectQuizOption(el){
      const qid=el.dataset.question;
      document.querySelectorAll(`.quiz-option[data-question="${qid}"]`).forEach(o=>o.classList.remove('selected'));
      el.classList.add('selected');
    }
    function checkQuizAnswers(){
      let correct=0;
      quizQuestions.forEach((q,i)=>{
        const selected=document.querySelector(`.quiz-option[data-question="${i}"].selected`);
        const all=document.querySelectorAll(`.quiz-option[data-question="${i}"]`);
        if(selected){
          const sel=parseInt(selected.dataset.option,10);
          all.forEach(opt=>{
            const idx=parseInt(opt.dataset.option,10);
            if(idx===q.correct) opt.classList.add('correct');
            else if(opt.classList.contains('selected')) opt.classList.add('wrong');
          });
          if(sel===q.correct) correct++;
        }
      });
      const pct=(correct/quizQuestions.length)*100;
      document.getElementById('quiz-score').textContent=`${correct}/${quizQuestions.length}`;
      const msg=document.getElementById('quiz-message');
      if(pct>=80){ msg.textContent='M√ºkemmel! üèÜ'; addScore(200); unlockAchievement(7); }
      else if(pct>=60){ msg.textContent='ƒ∞yi! üëç'; addScore(150); }
      else { msg.textContent='Daha √ßok pratik! üí™'; addScore(100); }
      document.getElementById('quiz-result').classList.remove('hidden');
      document.getElementById('check-answers').disabled=true;
      gameState.quizCompleted=true;
      checkMissions();
    }

    /***********************
     * MAPS + LAYERS
     ***********************/
    const trCenter=[39.0,35.0];
    const trZoom=6;

    let mapNormal, mapLeft, mapRight;
    let topoN, roadsN, waterN, settleN, riskN;
    let topoL, roadsL, waterL, settleL, riskL;
    let topoR, roadsR, waterR, settleR, riskR;

    function setTileOpacity(tile, on, opacityOn){ tile.setOpacity(on ? opacityOn : 0); }
    function setGroupVisible(group, on, strokeOpacity, fillOpacity){
      group.eachLayer(layer=>{
        if(layer.setStyle){
          layer.setStyle({
            opacity: on ? strokeOpacity : 0,
            fillOpacity: on ? fillOpacity : 0
          });
        }
      });
    }

    // Daha belirgin (g√∂zle g√∂r√ºl√ºr) √∂rnek su/≈üehir/risk
    const waterLines = [
      [[41.2,28.8],[41.3,31.2],[41.15,33.4],[41.1,35.6],[41.2,37.4]],
      [[39.9,32.7],[39.4,34.7],[38.9,36.4],[37.9,38.7],[37.0,39.2]],
      [[38.7,26.9],[38.8,28.3],[38.6,29.6],[38.3,30.6]]
    ];
    const lakes = [
      ["Van G√∂l√º",38.6,42.9,65000],
      ["Tuz G√∂l√º",38.8,33.3,55000],
      ["Bey≈üehir",37.7,31.7,32000],
      ["Eƒüirdir",37.9,30.9,26000]
    ];
    const cities = [
      ["ƒ∞stanbul",41.0082,28.9784],["Ankara",39.9334,32.8597],["ƒ∞zmir",38.4237,27.1428],
      ["Bursa",40.195,29.06],["Antalya",36.8969,30.7133],["Adana",37.0,35.3213],
      ["Gaziantep",37.0662,37.3833],["Konya",37.8715,32.4846],["Kayseri",38.7225,35.4875],
      ["Trabzon",41.0015,39.7178],["Diyarbakƒ±r",37.9144,40.2306],["Samsun",41.2867,36.33]
    ];

    function buildWaterLayer(){
      const g=L.layerGroup();
      waterLines.forEach(p=>L.polyline(p,{
        color:"#00c2ff",weight:8,opacity:0,lineJoin:"round"
      }).addTo(g));
      lakes.forEach(([n,lat,lng,r])=>{
        L.circle([lat,lng],{
          radius:r,
          color:"#00c2ff",fillColor:"#00c2ff",
          opacity:0,fillOpacity:0,weight:2
        }).bindTooltip("üíß "+n).addTo(g);
      });
      return g;
    }
    function buildSettlementLayer(){
      const g=L.layerGroup();
      cities.forEach(([n,lat,lng])=>{
        L.circleMarker([lat,lng],{
          radius:11,
          color:"#ffffff",
          fillColor:"#ff6d00",
          opacity:0,fillOpacity:0,weight:2
        }).bindTooltip("üèòÔ∏è "+n).addTo(g);
      });
      return g;
    }
    function buildRiskLayer(){
      const g=L.layerGroup();
      const p1=L.polygon([[41.35,28.65],[41.45,29.25],[41.20,29.35],[41.10,28.85]],
        {color:"#ffea00",fillColor:"#ffea00",opacity:0,fillOpacity:0,weight:2}).bindTooltip("üü° Sel riski (√∂rnek)");
      const p2=L.polygon([[40.95,39.25],[41.20,39.95],[40.75,40.35],[40.55,39.70]],
        {color:"#ff1744",fillColor:"#ff1744",opacity:0,fillOpacity:0,weight:2}).bindTooltip("üî¥ Heyelan riski (√∂rnek)");
      p1.addTo(g);p2.addTo(g);
      return g;
    }

    function applyLayerState(topo, roads, water, settle, risk){
      topo.setOpacity(1); // topo always on
      setTileOpacity(roads, gameState.activeLayers.includes("roads"), 0.9);
      setGroupVisible(water, gameState.activeLayers.includes("water"), 1, 0.22);
      setGroupVisible(settle, gameState.activeLayers.includes("settlement"), 1, 0.9);
      setGroupVisible(risk, gameState.activeLayers.includes("risk"), 1, 0.22);
    }

    function refreshAllMaps(){
      applyLayerState(topoN, roadsN, waterN, settleN, riskN);
      if(mapLeft && mapRight){
        applyLayerState(topoL, roadsL, waterL, settleL, riskL);
        applyLayerState(topoR, roadsR, waterR, settleR, riskR);
      }
      mapNormal.invalidateSize(false);
      if(mapLeft){ mapLeft.invalidateSize(false); mapRight.invalidateSize(false); }
    }

    function initNormalMap(){
      mapNormal=L.map("mapNormal",{zoomControl:true,preferCanvas:true}).setView(trCenter,trZoom);

      topoN=L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{
        maxZoom:17,opacity:1,attribution:"¬© OpenTopoMap, ¬© OpenStreetMap"
      }).addTo(mapNormal);

      roadsN=L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{
        maxZoom:19,opacity:0,attribution:"¬© OpenStreetMap"
      }).addTo(mapNormal);

      waterN=buildWaterLayer().addTo(mapNormal);
      settleN=buildSettlementLayer().addTo(mapNormal);
      riskN=buildRiskLayer().addTo(mapNormal);

      refreshAllMaps();
      log1("Map OK ‚úÖ | Topo a√ßƒ±k, diƒüerleri kapalƒ±");
    }

    function initVrMapsIfNeeded(){
      if(mapLeft && mapRight) return;

      mapLeft=L.map("mapLeft",{zoomControl:false,attributionControl:false,preferCanvas:true}).setView(mapNormal.getCenter(), mapNormal.getZoom());
      mapRight=L.map("mapRight",{zoomControl:false,attributionControl:false,preferCanvas:true}).setView(mapNormal.getCenter(), mapNormal.getZoom());

      topoL=L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,opacity:1}).addTo(mapLeft);
      topoR=L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,opacity:1}).addTo(mapRight);

      roadsL=L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{maxZoom:19,opacity:0}).addTo(mapLeft);
      roadsR=L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{maxZoom:19,opacity:0}).addTo(mapRight);

      waterL=buildWaterLayer().addTo(mapLeft);
      settleL=buildSettlementLayer().addTo(mapLeft);
      riskL=buildRiskLayer().addTo(mapLeft);

      waterR=buildWaterLayer().addTo(mapRight);
      settleR=buildSettlementLayer().addTo(mapRight);
      riskR=buildRiskLayer().addTo(mapRight);

      // sync views
      let lock=false;
      mapLeft.on("move",()=>{
        if(lock) return; lock=true;
        mapRight.setView(mapLeft.getCenter(), mapLeft.getZoom(), {animate:false});
        lock=false;
      });
      mapRight.on("move",()=>{
        if(lock) return; lock=true;
        mapLeft.setView(mapRight.getCenter(), mapRight.getZoom(), {animate:false});
        lock=false;
      });

      refreshAllMaps();
      log2("VR maps OK ‚úÖ");
    }

    function setLayerButtonsUI(layerName, isOn){
      if(layerName==="topography") return;
      document.querySelectorAll(`.layer-btn[data-layer="${layerName}"]`).forEach(btn=>{
        btn.classList.toggle("inactive", !isOn);
      });
    }

    function toggleLayer(layerName){
      if(layerName==="topography"){
        updateTaskPrompt("Topografya hep a√ßƒ±k üèîÔ∏è","Topografya kapatƒ±lmaz. Diƒüer katmanlarƒ± a√ß/kapat yap.");
        log2("Topo button pressed (no toggle)");
        return;
      }

      const idx=gameState.activeLayers.indexOf(layerName);
      const willTurnOn = idx === -1;

      if(willTurnOn){
        gameState.activeLayers.push(layerName);
        gameState.layersUsed.add(layerName);
        if(gameState.layersUsed.size>=2) unlockAchievement(1);
        if(layerName==="roads") gameState.roadsExplored=true;
        addScore(10);
        log1(`Layer ON ‚úÖ: ${layerName}`);
      } else {
        gameState.activeLayers.splice(idx,1);
        addScore(3);
        log1(`Layer OFF ‚õîÔ∏è: ${layerName}`);
      }

      setLayerButtonsUI(layerName, willTurnOn);
      refreshAllMaps();

      updateTaskPrompt("Katman g√ºncellendi ‚úÖ","A√ßƒ±k: " + gameState.activeLayers.join(", "));
      checkMissions();
    }

    function panByDirection(dir){
      const step=0.55;
      const c=mapNormal.getCenter();
      const d={
        n:[ step,0], s:[-step,0], e:[0, step], w:[0,-step],
        ne:[ step, step], nw:[ step,-step], se:[-step, step], sw:[-step,-step]
      }[dir]||[0,0];

      mapNormal.panTo([c.lat+d[0], c.lng+d[1]], {animate:true,duration:0.25});
      gameState.directionsSet.add(dir);
      if(gameState.directionsSet.size>=4) unlockAchievement(2);
      addScore(2);
      log2("Pan: "+dir);
      checkMissions();
    }

    function clickInfoPoint(type){
      if(type==="risk"){
        gameState.riskPointClicked=true; unlockAchievement(3); addScore(25);
        log2("Info: risk clicked");
      }else if(type==="water"){
        gameState.waterPointClicked=true; unlockAchievement(4); addScore(25);
        log2("Info: water clicked");
      }else{
        addScore(10);
        log2("Info: topo clicked");
      }
      checkMissions();
    }

    /***********************
     * VR Mode
     ***********************/
    let vrOn=false;
    let motionEnabled=false;
    let lastMotionTs=0;

    function isLandscape(){ return window.matchMedia("(orientation: landscape)").matches; }
    function updateRotateHint(){
      document.getElementById("rotateHint").classList.toggle("on", vrOn && !isLandscape());
    }

    async function tryLockLandscape(){
      try{
        if(screen.orientation && screen.orientation.lock){
          await screen.orientation.lock("landscape");
        }
      }catch(_){}
    }

    function enterVR(){
      vrOn=true;
      document.getElementById("vrOverlay").classList.add("on");
      document.body.classList.add("vr-lock");
      const vrBtn=document.getElementById("vr-toggle");
      vrBtn.classList.add("active");
      vrBtn.textContent="‚úñ VR Kapat";
      tryLockLandscape();
      updateRotateHint();

      initVrMapsIfNeeded();

      const c=mapNormal.getCenter();
      const z=mapNormal.getZoom();
      mapLeft.setView(c,z,{animate:false});
      mapRight.setView(c,z,{animate:false});

      refreshAllMaps();
      setTimeout(()=>{ mapLeft.invalidateSize(); mapRight.invalidateSize(); },120);
      log1("VR ON ‚úÖ");
    }

    function exitVR(){
      vrOn=false;
      document.getElementById("vrOverlay").classList.remove("on");
      document.body.classList.remove("vr-lock");
      const vrBtn=document.getElementById("vr-toggle");
      vrBtn.classList.remove("active");
      vrBtn.textContent="ü•Ω VR Modu";
      motionEnabled=false;
      document.getElementById("motionBtn").textContent="üéõ Ba≈ü ƒ∞zleme ƒ∞zni";
      updateRotateHint();
      log1("VR OFF ‚õîÔ∏è");
    }

    async function requestMotionPermission(){
      // IMPORTANT: iOS uses permission gating
      try{
        // HTTPS check:
        if(location.protocol !== "https:" && location.hostname !== "localhost"){
          alert("Ba≈ü izleme i√ßin sayfa HTTPS olmalƒ±.\nGitHub Pages zaten HTTPS olmalƒ±.\nLinkin https:// ile ba≈üladƒ±ƒüƒ±ndan emin ol.");
          log2("Motion blocked: not https");
          return;
        }

        if(typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function"){
          const res = await DeviceOrientationEvent.requestPermission();
          if(res !== "granted") throw new Error("ƒ∞zin verilmedi");
        }
        motionEnabled=true;
        document.getElementById("motionBtn").textContent="‚úÖ Ba≈ü ƒ∞zleme A√ßƒ±k";
        log2("Motion enabled ‚úÖ");
      }catch(e){
        alert("Ba≈ü izleme a√ßƒ±lamadƒ±.\n\n1) HTTPS olmalƒ±\n2) Safari i√ßinde a√ßƒ±lmƒ±≈ü olmalƒ±\n3) ƒ∞zin 'Allow' olmalƒ±\n\nDetay: "+(e?.message||e));
        log2("Motion failed: "+(e?.message||e));
      }
    }

    function headingToDir(deg){
      const dirs=["N","NE","E","SE","S","SW","W","NW"];
      const idx=Math.round((((deg%360)+360)%360)/45)%8;
      return dirs[idx];
    }

    window.addEventListener("deviceorientation",(e)=>{
      if(!vrOn || !motionEnabled || !mapLeft) return;

      const now=performance.now();
      if(now-lastMotionTs<35) return;
      lastMotionTs=now;

      const alpha=(e.alpha ?? 0);
      const beta=(e.beta ?? 0);
      const heading=((alpha%360)+360)%360;

      document.getElementById("compassDeg").textContent = Math.round(heading)+"¬∞";
      document.getElementById("compassDir").textContent = headingToDir(heading);

      // VR-like pan
      const yaw=((heading+540)%360)-180;
      const pitch=Math.max(-35, Math.min(35, beta));
      const z=mapLeft.getZoom();
      const scale=0.0012 * Math.pow(2,(7-z));
      const dx=yaw*scale;
      const dy=pitch*scale;

      const c=mapLeft.getCenter();
      const next=L.latLng(c.lat + (-dy), c.lng + (dx));
      mapLeft.panTo(next,{animate:false});
    }, {passive:true});

    window.addEventListener("resize", ()=>{ if(vrOn){ updateRotateHint(); if(mapLeft){ mapLeft.invalidateSize(); mapRight.invalidateSize(); } } },{passive:true});
    window.addEventListener("orientationchange", ()=>{ if(vrOn){ setTimeout(()=>{ updateRotateHint(); if(mapLeft){ mapLeft.invalidateSize(); mapRight.invalidateSize(); } },250); } });

    /***********************
     * BEP
     ***********************/
    function toggleBEPMode(){
      gameState.bepMode=!gameState.bepMode;
      document.body.classList.toggle("bep-mode");
      const btn=document.getElementById("bep-toggle");
      btn.classList.toggle("active");
      btn.textContent=gameState.bepMode ? "Normal Mod" : "BEP Modu";
      addScore(2);
      log2("BEP: "+(gameState.bepMode?"ON":"OFF"));
    }

    /***********************
     * Event listeners
     ***********************/
    function setupEventListeners(){
      // Layer buttons (Normal + VR HUD)
      document.querySelectorAll('.layer-btn').forEach(btn=>{
        bindTap(btn, ()=>{
          log2("Tap: layer button -> "+btn.dataset.layer);
          toggleLayer(btn.dataset.layer);
        });
      });

      // Direction buttons
      document.querySelectorAll('.direction-btn').forEach(btn=>{
        bindTap(btn, ()=> panByDirection(btn.dataset.direction));
      });

      // Info points
      document.querySelectorAll('.ar-info-point').forEach(p=>{
        bindTap(p, ()=> clickInfoPoint(p.dataset.info));
      });

      // Quiz
      document.querySelectorAll('.quiz-option').forEach(opt=>{
        bindTap(opt, ()=> selectQuizOption(opt));
      });
      bindTap(document.getElementById('check-answers'), checkQuizAnswers);

      // BEP + VR
      bindTap(document.getElementById('bep-toggle'), toggleBEPMode);
      bindTap(document.getElementById('vr-toggle'), ()=>{ vrOn ? exitVR() : enterVR(); });
      bindTap(document.getElementById('vrCloseBtn'), exitVR);
      bindTap(document.getElementById('motionBtn'), requestMotionPermission);

      // VR bottom
      bindTap(document.getElementById('zoomIn'), ()=>{ if(mapLeft){ mapLeft.zoomIn(); log2("VR zoom in"); } });
      bindTap(document.getElementById('zoomOut'), ()=>{ if(mapLeft){ mapLeft.zoomOut(); log2("VR zoom out"); } });
      bindTap(document.getElementById('centerTR'), ()=>{
        if(mapLeft){
          mapLeft.setView(trCenter,trZoom,{animate:true});
          log2("VR center TR");
        }
      });
    }

    /***********************
     * INIT
     ***********************/
    function init(){
      renderMissions();
      renderAchievements();
      renderQuiz();

      initNormalMap();
      setupEventListeners();
      updateStats();

      updateTaskPrompt("Hazƒ±r ‚úÖ","≈ûimdi 'Su'ya bas: mavi nehir/g√∂l g√∂r√ºnmeli. Tekrar bas: kapanmalƒ±.");
      checkMissions();

      log2("iOS click binder aktif ‚úÖ");
    }

    init();
  </script>
</body>
</html>
