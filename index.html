<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HaritaG√∂z - Mobil + VR Tam Sƒ±ƒüdƒ±rma</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body{
      width:100%; height:100%;
      overflow:hidden;                 /* sayfa scroll yok */
      background: linear-gradient(135deg,#1a2a3a 0%,#2d4a5c 100%);
      color:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    #screen{ width:100vw; height:100vh; overflow:hidden; position:relative; }
    #app{
      width: 1200px;                   /* tasarƒ±m geni≈üliƒüi */
      /* y√ºkseklik dinamik, JS √∂l√ß√ºp scale eder */
      transform-origin: top left;
      will-change: transform;
    }

    /* HEADER */
    .header{
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid rgba(76,175,80,.30);
      padding: 14px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .logo{
      font-size: 26px; font-weight: 900; color:#4CAF50;
      display:flex; align-items:center; gap:10px; white-space:nowrap;
    }
    .stats{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .stat-item{ text-align:center; min-width:70px; }
    .stat-value{ font-size:22px; font-weight:900; color:#FFC107; }
    .stat-label{ font-size:12px; color:#B0BEC5; }

    .pill{
      border:none; border-radius:20px;
      padding: 10px 16px;
      color:#fff; font-weight:900;
      cursor:pointer; user-select:none; touch-action: manipulation;
      transition: transform .12s;
    }
    .pill:hover{ transform: scale(1.02); }
    .bep{ background:#2196F3; }
    .bep.active{ background:#FF9800; }
    .vr{ background:#6A1B9A; }
    .vr.active{ background:#D32F2F; }

    /* LAYOUT */
    .content{
      padding: 14px 16px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      padding: 16px;
      overflow:hidden;
    }

    .title{
      font-size: 22px;
      font-weight: 900;
      color:#4CAF50;
      display:flex; align-items:center; gap:10px;
      margin-bottom: 12px;
    }

    /* SIM */
    .task{
      background: rgba(255,193,7,.18);
      border: 2px solid #FFC107;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .task b{ color:#FFC107; display:block; margin-bottom:6px; }

    .sim{
      background:#121212;
      border:3px solid #4CAF50;
      border-radius:16px;
      padding:14px;
      overflow:hidden;
    }
    .viewport{
      width:100%;
      height:360px;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      background: linear-gradient(to bottom, #87CEEB 0%, #90EE90 55%, #8B4513 100%);
    }
    .layers{ position:absolute; inset:0; pointer-events:none; }
    .layer{ position:absolute; inset:0; transition: opacity .2s; }
    .hidden{ opacity:0; }

    .topography-layer{
      background: repeating-linear-gradient(
        45deg, transparent, transparent 10px,
        rgba(139,69,19,.22) 10px, rgba(139,69,19,.22) 20px
      );
    }
    .roads-layer{
      background:
        repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(255,255,0,.65) 50px, rgba(255,255,0,.65) 52px),
        repeating-linear-gradient(0deg, transparent, transparent 80px, rgba(255,255,0,.65) 80px, rgba(255,255,0,.65) 82px);
    }
    .water-layer{
      background:
        radial-gradient(circle at 30% 70%, rgba(30,144,255,.6) 0%, transparent 30%),
        radial-gradient(circle at 70% 40%, rgba(30,144,255,.5) 0%, transparent 25%);
    }
    .settlement-layer{
      background:
        radial-gradient(circle at 50% 30%, rgba(255,165,0,.42) 0%, transparent 20%),
        radial-gradient(circle at 20% 60%, rgba(255,165,0,.32) 0%, transparent 15%),
        radial-gradient(circle at 80% 70%, rgba(255,165,0,.32) 0%, transparent 15%);
    }
    .risk-layer{
      background:
        radial-gradient(circle at 60% 80%, rgba(255,0,0,.55) 0%, transparent 25%),
        radial-gradient(circle at 25% 30%, rgba(255,0,0,.42) 0%, transparent 20%);
    }

    .info{
      position:absolute;
      padding: 9px 12px;
      border-radius: 12px;
      background: rgba(76,175,80,.92);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }

    .controls{
      margin-top:12px;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .12s;
      display:flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.topo{ background: linear-gradient(135deg,#8B4513,#D2691E); color:#fff; }
    .btn.roads{ background: linear-gradient(135deg,#FFD700,#FFA500); color:#1c1c1c; }
    .btn.water{ background: linear-gradient(135deg,#1E90FF,#4169E1); color:#fff; }
    .btn.settle{ background: linear-gradient(135deg,#FF6347,#FF8C00); color:#fff; }
    .btn.risk{ background: linear-gradient(135deg,#DC143C,#8B0000); color:#fff; }
    .inactive{ opacity:.40; filter: grayscale(1); }

    .dir{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 56px);
      gap:8px;
      justify-content:center;
    }
    .dir button{
      width:56px; height:44px;
      border:none; border-radius:12px;
      background:#2196F3;
      color:#fff;
      font-size:18px; font-weight:900;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }

    /* RIGHT PANEL (scroll yok, hepsi sƒ±ƒüacak diye √∂l√ßekleyeceƒüiz) */
    .side{
      display:grid;
      grid-template-rows: auto auto auto;
      gap:14px;
    }

    .mission{
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, rgba(33,150,243,.18), rgba(76,175,80,.18));
      padding: 12px;
      margin-bottom: 10px;
      position: relative;
    }
    .mission .mTitle{ font-weight: 900; color:#4CAF50; margin-bottom:6px; }
    .mission .mDesc{ font-size: 12px; color:#CFD8DC; margin-bottom:8px; }
    .mission .mReward{ font-size: 12px; font-weight: 900; color:#FFC107; }
    .badge{
      position:absolute; top:10px; right:10px;
      width:26px; height:26px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.35);
      font-size: 14px;
    }

    .ach{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .achItem{
      border-radius:14px;
      border:2px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:10px;
      text-align:center;
    }
    .achItem.unlocked{
      border-color:#FFC107;
      background: rgba(255,193,7,.10);
    }
    .achIcon{ font-size: 30px; margin-bottom:6px; }
    .achName{ font-size: 12px; font-weight:900; }
    .achDesc{ font-size: 10px; color:#B0BEC5; }

    .quizQ{
      border-radius:14px;
      background: rgba(255,255,255,.06);
      padding:12px;
      margin-bottom:10px;
    }
    .quizQ b{ display:block; margin-bottom:8px; font-size:12px; color:#E0E0E0; }
    .opt{
      border:2px solid transparent;
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      font-size:12px;
      margin-bottom:8px;
    }
    .opt.selected{ border-color:#FFC107; background: rgba(255,193,7,.18); }
    .opt.correct{ border-color:#4CAF50; background: rgba(76,175,80,.18); }
    .opt.wrong{ border-color:#F44336; background: rgba(244,67,54,.18); }

    .primary{
      width:100%;
      border:none;
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg,#4CAF50,#8BC34A);
      user-select:none;
      touch-action: manipulation;
    }
    .primary:disabled{ opacity:.5; cursor:not-allowed; }

    .result{
      margin-top:10px;
      border-radius:16px;
      border:2px solid #4CAF50;
      padding:12px;
      text-align:center;
      background: linear-gradient(135deg, rgba(76,175,80,.18), rgba(33,150,243,.18));
      display:none;
    }

    /* VR OVERLAY */
    #vrStage{
      position:fixed;
      inset:0;
      background:#000;
      z-index:9999;
      visibility:hidden;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s;
    }
    body.vr-on #vrStage{
      visibility:visible;
      opacity:1;
      pointer-events:auto;
    }
    body.vr-on{ overflow:hidden; touch-action:none; }

    .vrTop{
      position:fixed;
      top:10px; left:10px;
      z-index:10000;
      display:flex; gap:10px; align-items:center;
    }
    .vrClose{
      border:none; border-radius:14px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background: rgba(211,47,47,.95);
      user-select:none;
      touch-action: manipulation;
    }

    .eye{
      position:absolute; top:0;
      width:50vw; height:100vh;
      overflow:hidden;
    }
    .eye.left{ left:0; }
    .eye.right{ right:0; }
    .eyeInner{
      transform-origin: top left;
      will-change: transform;
    }

    /* BEP */
    body.bep-mode{ font-size: 18px; }
  </style>
</head>

<body>
  <div id="screen">
    <div id="app">
      <div class="header">
        <div class="logo">üó∫Ô∏è HaritaG√∂z</div>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="score">0</div>
            <div class="stat-label">Puan</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="level">1</div>
            <div class="stat-label">Seviye</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="missionsCompleted">0/8</div>
            <div class="stat-label">G√∂rev</div>
          </div>
          <button class="pill bep" id="bepBtn" type="button">BEP Modu</button>
          <button class="pill vr" id="vrBtn" type="button">VR Modu</button>
        </div>
      </div>

      <div class="content">
        <!-- LEFT -->
        <div class="card">
          <div class="title">üéØ AR Harita Sim√ºlat√∂r√º</div>

          <div class="task">
            <b>Ho≈ü geldin!</b>
            Katmanlarƒ± a√ß/kapat. Y√∂n tu≈ülarƒ±yla farklƒ± y√∂ne bak. VR‚Äôde de aynƒ± ≈üekilde √ßalƒ±≈üƒ±r.
          </div>

          <div class="sim">
            <div class="viewport" id="viewport">
              <div class="layers">
                <div class="layer topography-layer" id="layer-topography"></div>
                <div class="layer roads-layer hidden" id="layer-roads"></div>
                <div class="layer water-layer hidden" id="layer-water"></div>
                <div class="layer settlement-layer hidden" id="layer-settlement"></div>
                <div class="layer risk-layer hidden" id="layer-risk"></div>
              </div>

              <div class="info" style="top:26%; left:26%" data-info="topography">üìä Topografya</div>
              <div class="info" style="top:70%; left:58%" data-info="risk">‚ö†Ô∏è Risk</div>
              <div class="info" style="top:40%; left:70%" data-info="water">üíß Su</div>
            </div>

            <div class="controls">
              <button class="btn topo" data-layer="topography" type="button">üèîÔ∏è Topografya</button>
              <button class="btn roads inactive" data-layer="roads" type="button">üõ£Ô∏è Ula≈üƒ±m</button>
              <button class="btn water inactive" data-layer="water" type="button">üíß Su</button>
              <button class="btn settle inactive" data-layer="settlement" type="button">üèòÔ∏è Yerle≈üim</button>
              <button class="btn risk inactive" data-layer="risk" type="button">‚ö†Ô∏è Risk</button>
            </div>

            <div class="dir">
              <button data-dir="nw" type="button">‚ÜñÔ∏è</button>
              <button data-dir="n"  type="button">‚¨ÜÔ∏è</button>
              <button data-dir="ne" type="button">‚ÜóÔ∏è</button>
              <button data-dir="w"  type="button">‚¨ÖÔ∏è</button>
              <button data-dir="e"  type="button">‚û°Ô∏è</button>
              <button data-dir="sw" type="button">‚ÜôÔ∏è</button>
              <button data-dir="s"  type="button">‚¨áÔ∏è</button>
              <button data-dir="se" type="button">‚ÜòÔ∏è</button>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="side">
          <div class="card">
            <div class="title">üéØ G√∂revler</div>
            <div id="missions"></div>
          </div>

          <div class="card">
            <div class="title">üèÜ Ba≈üarƒ±mlar</div>
            <div class="ach" id="achievements"></div>
          </div>

          <div class="card">
            <div class="title">üìù Test</div>
            <div id="quiz"></div>
            <button class="primary" id="checkBtn" type="button">Cevaplarƒ± Kontrol Et</button>
            <div class="result" id="result">
              <div style="font-size:26px;font-weight:900;color:#FFC107" id="resultScore"></div>
              <div style="margin-top:6px" id="resultMsg"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- VR overlay -->
  <div id="vrStage" aria-hidden="true">
    <div class="vrTop">
      <button class="vrClose" id="vrClose" type="button">‚úï Kapat</button>
    </div>
    <div class="eye left"><div class="eyeInner" id="eyeL"></div></div>
    <div class="eye right"><div class="eyeInner" id="eyeR"></div></div>
  </div>

  <script>
    /************ iOS i√ßin saƒülam tap ************/
    function bindTap(el, fn){
      if(!el) return;
      const fire = (e)=>{ try{ e.preventDefault?.(); }catch(_){} fn(); };
      el.addEventListener('pointerup', fire, {passive:false});
      el.addEventListener('touchend', fire, {passive:false});
      el.addEventListener('click', (e)=>{ e.preventDefault(); fn(); }, false);
    }

    /************ Dƒ∞NAMƒ∞K ‚ÄúTAM SAYFA SIƒûDIR‚Äù SCALE ************
     * app'in ger√ßek boyutunu √∂l√ßer (width/height) ve viewport'a sƒ±ƒüdƒ±rƒ±r.
     ***********************************************************/
    const fitState = { w:1200, h:800 };

    function measureApp(){
      const app = document.getElementById('app');

      // √∂l√ß√ºm i√ßin ge√ßici olarak scale kaldƒ±r
      const prev = app.style.transform;
      app.style.transform = 'none';

      // ger√ßek boyut
      const rect = app.getBoundingClientRect();
      fitState.w = rect.width;
      fitState.h = rect.height;

      // geri koy (applyFit zaten tekrar basacak)
      app.style.transform = prev;
    }

    function applyFit(){
      const app = document.getElementById('app');
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      // √∂nce √∂l√ß
      measureApp();

      const s = Math.min(vw / fitState.w, vh / fitState.h);
      app.style.transform = `scale(${s})`;
    }

    /************ GAME STATE ************/
    const gameState = {
      score:0, level:1, completedMissions:0,
      activeLayers:['topography'],
      directionsExplored:0,
      layersUsed:new Set(['topography']),
      riskPointClicked:false,
      waterPointClicked:false,
      roadsExplored:false,
      quizCompleted:false,
      bepMode:false
    };

    const missions = [
      { id:1, title:'Katmanlarƒ± Ke≈üfet', desc:'En az 3 katmanƒ± a√ß', reward:50, status:'active', check:()=>gameState.activeLayers.length>=3 },
      { id:2, title:'Y√∂n Bul', desc:'4 farklƒ± y√∂ne bak', reward:75, status:'locked', check:()=>gameState.directionsExplored>=4 },
      { id:3, title:'Risk Analizi', desc:'Risk katmanƒ± + risk noktasƒ±na dokun', reward:100, status:'locked', check:()=>gameState.activeLayers.includes('risk') && gameState.riskPointClicked },
      { id:4, title:'Su Kaynaklarƒ±', desc:'Su katmanƒ± + su noktasƒ±na dokun', reward:100, status:'locked', check:()=>gameState.activeLayers.includes('water') && gameState.waterPointClicked },
      { id:5, title:'G√ºzergah', desc:'Ula≈üƒ±m katmanƒ±nƒ± ke≈üfet', reward:150, status:'locked', check:()=>gameState.activeLayers.includes('roads') && gameState.roadsExplored },
      { id:6, title:'Yerle≈üim', desc:'Yerle≈üim katmanƒ±nƒ± a√ß', reward:150, status:'locked', check:()=>gameState.activeLayers.includes('settlement') },
      { id:7, title:'Harita Uzmanƒ±', desc:'Testi tamamla', reward:200, status:'locked', check:()=>gameState.quizCompleted },
      { id:8, title:'AR Ustasƒ±', desc:'1000 puana ula≈ü', reward:300, status:'locked', check:()=>gameState.completedMissions>=7 && gameState.score>=1000 }
    ];

    const achievements = [
      { id:1, icon:'üó∫Ô∏è', name:'ƒ∞lk Ke≈üif', desc:'Bir katman a√ßtƒ±n', unlocked:false },
      { id:2, icon:'üß≠', name:'Y√∂n Bulma', desc:'4 y√∂ne baktƒ±n', unlocked:false },
      { id:3, icon:'‚ö†Ô∏è', name:'Risk', desc:'Risk noktasƒ±nƒ± buldun', unlocked:false },
      { id:4, icon:'üíß', name:'Su', desc:'Su noktasƒ±nƒ± buldun', unlocked:false },
      { id:5, icon:'üèÜ', name:'ƒ∞lk G√∂rev', desc:'ƒ∞lk g√∂revi bitirdin', unlocked:false },
      { id:6, icon:'üìö', name:'500', desc:'500 puana ula≈ütƒ±n', unlocked:false },
      { id:7, icon:'üéì', name:'Test', desc:'Testi ge√ßtin', unlocked:false },
      { id:8, icon:'üëë', name:'Usta', desc:'Hepsi tamam', unlocked:false }
    ];

    const quizQuestions = [
      { q:'Y√ºksekliƒüi g√∂steren katman hangisi?', opts:['Topografya','Ula≈üƒ±m','Yerle≈üim','Risk'], c:0 },
      { q:'Sel riski i√ßin birlikte hangi katmanlar?', opts:['Sadece risk','Su + topografya','Sadece yerle≈üim','Sadece ula≈üƒ±m'], c:1 },
      { q:'N√ºfus yoƒüunluƒüu i√ßin?', opts:['Topografya','Su','Yerle≈üim','Ula≈üƒ±m'], c:2 },
      { q:'G√ºvenli g√ºzergah i√ßin √∂nemli?', opts:['Ula≈üƒ±m + risk','Sadece topo','Sadece su','Sadece yerle≈üim'], c:0 },
      { q:'AR avantajƒ± nedir?', opts:['Pahalƒ±dƒ±r','√áevre + harita birle≈üir','Sadece sƒ±nƒ±fta','Tek katman'], c:1 }
    ];

    function updateStats(){
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('level').textContent = gameState.level;
      document.getElementById('missionsCompleted').textContent = `${gameState.completedMissions}/${missions.length}`;
    }

    function addScore(p){
      gameState.score += p;
      if(gameState.score >= 500) unlockAchievement(6);
      const newLevel = Math.floor(gameState.score / 200) + 1;
      gameState.level = Math.max(gameState.level, newLevel);
      updateStats();
    }

    function unlockAchievement(id){
      const a = achievements.find(x=>x.id===id);
      if(!a || a.unlocked) return;
      a.unlocked = true;
      renderAchievements();
      addScore(50);
    }

    function renderMissions(){
      const box = document.getElementById('missions');
      box.innerHTML = missions.map(m=>{
        const icon = (m.status==='locked')?'üîí':(m.status==='active')?'‚ö°':'‚úÖ';
        return `
          <div class="mission">
            <div class="badge">${icon}</div>
            <div class="mTitle">${m.title}</div>
            <div class="mDesc">${m.desc}</div>
            <div class="mReward">+${m.reward} puan</div>
          </div>
        `;
      }).join('');
      updateStats();
    }

    function renderAchievements(){
      const box = document.getElementById('achievements');
      box.innerHTML = achievements.map(a=>`
        <div class="achItem ${a.unlocked?'unlocked':''}">
          <div class="achIcon">${a.icon}</div>
          <div class="achName">${a.name}</div>
          <div class="achDesc">${a.desc}</div>
        </div>
      `).join('');
    }

    function renderQuiz(){
      const box = document.getElementById('quiz');
      box.innerHTML = quizQuestions.map((qq,i)=>{
        const opts = qq.opts.map((t,j)=>`<div class="opt" data-q="${i}" data-o="${j}">${t}</div>`).join('');
        return `<div class="quizQ"><b>${i+1}. ${qq.q}</b>${opts}</div>`;
      }).join('');
    }

    function completeMission(idx){
      const m = missions[idx];
      if(m.status==='completed') return;
      m.status='completed';
      gameState.completedMissions++;
      addScore(m.reward);
      if(gameState.completedMissions===1) unlockAchievement(5);
      if(idx < missions.length-1 && missions[idx+1].status==='locked') missions[idx+1].status='active';
    }

    function checkMissions(){
      missions.forEach((m,idx)=>{
        if(m.status==='active' && m.check()) completeMission(idx);
        if(m.status==='locked' && idx>0 && missions[idx-1].status==='completed') m.status='active';
      });
      renderMissions();
      if(vrState.on) rebuildVR();
      applyFit(); // i√ßerik deƒüi≈üince tekrar sƒ±ƒüdƒ±r
    }

    function toggleLayer(name){
      const layer = document.getElementById('layer-'+name);
      const btn = document.querySelector(`.btn[data-layer="${name}"]`);
      const isHidden = layer.classList.contains('hidden');

      if(isHidden){
        layer.classList.remove('hidden');
        btn.classList.remove('inactive');
        if(!gameState.activeLayers.includes(name)) gameState.activeLayers.push(name);
        gameState.layersUsed.add(name);
      }else{
        layer.classList.add('hidden');
        btn.classList.add('inactive');
        gameState.activeLayers = gameState.activeLayers.filter(x=>x!==name);
      }

      unlockAchievement(1);
      if(name==='roads') gameState.roadsExplored = true;
      checkMissions();
    }

    function changeDir(){
      gameState.directionsExplored++;
      if(gameState.directionsExplored>=4) unlockAchievement(2);

      const vp = document.getElementById('viewport');
      vp.style.filter = 'brightness(1.2)';
      setTimeout(()=>vp.style.filter='brightness(1)', 160);

      checkMissions();
    }

    function clickInfo(type){
      if(type==='risk'){ gameState.riskPointClicked=true; unlockAchievement(3); }
      if(type==='water'){ gameState.waterPointClicked=true; unlockAchievement(4); }
      addScore(25);
      checkMissions();
    }

    let selected = {};
    function selectOption(q,o,el){
      document.querySelectorAll(`.opt[data-q="${q}"]`).forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      selected[q]=o;
      if(vrState.on) rebuildVR();
    }

    function checkQuiz(){
      let correct=0;
      quizQuestions.forEach((qq,i)=>{
        const chosen = selected[i];
        const opts = document.querySelectorAll(`.opt[data-q="${i}"]`);
        opts.forEach(el=>{
          const oi = parseInt(el.dataset.o,10);
          el.classList.remove('correct','wrong');
          if(oi===qq.c) el.classList.add('correct');
          if(chosen===oi && chosen!==qq.c) el.classList.add('wrong');
        });
        if(chosen===qq.c) correct++;
      });

      const pct = (correct/quizQuestions.length)*100;
      const res = document.getElementById('result');
      res.style.display='block';
      document.getElementById('resultScore').textContent = `${correct}/${quizQuestions.length}`;

      let msg='';
      if(pct>=80){ msg='M√ºkemmel! üèÜ'; addScore(200); unlockAchievement(7); }
      else if(pct>=60){ msg='ƒ∞yi! üëç'; addScore(150); }
      else { msg='Daha fazla pratik! üí™'; addScore(100); }

      document.getElementById('resultMsg').textContent = msg;
      document.getElementById('checkBtn').disabled = true;

      gameState.quizCompleted=true;
      checkMissions();
    }

    function toggleBEP(){
      gameState.bepMode = !gameState.bepMode;
      document.body.classList.toggle('bep-mode');
      const b = document.getElementById('bepBtn');
      b.classList.toggle('active');
      b.textContent = gameState.bepMode ? 'Normal Mod' : 'BEP Modu';

      // BEP font b√ºy√ºt√ºr -> y√ºkseklik deƒüi≈üir -> tekrar sƒ±ƒüdƒ±r
      setTimeout(()=>{
        applyFit();
        if(vrState.on) rebuildVR();
      }, 0);
    }

    /************ VR ************/
    const vrState = { on:false };

    function vrEyeScale(){
      // g√∂z alanƒ±: 50vw x 100vh
      // base: fitState (app ger√ßek boyutu)
      const eyeW = window.innerWidth / 2;
      const eyeH = window.innerHeight;
      return Math.min(eyeW / fitState.w, eyeH / fitState.h) * 0.98;
    }

    function rebuildVR(){
      if(!vrState.on) return;

      // √∂nce √∂l√ß (VR scale doƒüru olsun)
      measureApp();

      const s = vrEyeScale();
      const appHTML = document.getElementById('app').outerHTML;

      const L = document.getElementById('eyeL');
      const R = document.getElementById('eyeR');
      L.innerHTML = appHTML;
      R.innerHTML = appHTML;

      const aL = L.querySelector('#app');
      const aR = R.querySelector('#app');
      aL.style.transform = `scale(${s})`;
      aR.style.transform = `scale(${s})`;

      aL.style.pointerEvents = 'none';
      aR.style.pointerEvents = 'none';
    }

    function openVR(){
      if(vrState.on) return;
      vrState.on=true;

      document.body.classList.add('vr-on');
      document.getElementById('vrStage').setAttribute('aria-hidden','false');

      const btn = document.getElementById('vrBtn');
      btn.classList.add('active');
      btn.textContent='VR Kapat';

      rebuildVR();
    }

    function closeVR(){
      if(!vrState.on) return;
      vrState.on=false;

      document.body.classList.remove('vr-on');
      document.getElementById('vrStage').setAttribute('aria-hidden','true');
      document.getElementById('eyeL').innerHTML='';
      document.getElementById('eyeR').innerHTML='';

      const btn = document.getElementById('vrBtn');
      btn.classList.remove('active');
      btn.textContent='VR Modu';
    }

    function toggleVR(){
      if(vrState.on) closeVR();
      else openVR();
    }

    function wireEvents(){
      document.querySelectorAll('.btn[data-layer]').forEach(b=>{
        bindTap(b, ()=>toggleLayer(b.dataset.layer));
      });
      document.querySelectorAll('.dir button').forEach(b=>{
        bindTap(b, ()=>changeDir(b.dataset.dir));
      });
      document.querySelectorAll('.info').forEach(p=>{
        bindTap(p, ()=>clickInfo(p.dataset.info));
      });

      document.getElementById('quiz').addEventListener('pointerup', (e)=>{
        const el = e.target.closest('.opt');
        if(!el) return;
        e.preventDefault();
        selectOption(parseInt(el.dataset.q,10), parseInt(el.dataset.o,10), el);
      }, {passive:false});

      document.getElementById('quiz').addEventListener('touchend', (e)=>{
        const el = e.target.closest('.opt');
        if(!el) return;
        e.preventDefault();
        selectOption(parseInt(el.dataset.q,10), parseInt(el.dataset.o,10), el);
      }, {passive:false});

      bindTap(document.getElementById('checkBtn'), checkQuiz);
      bindTap(document.getElementById('bepBtn'), toggleBEP);
      bindTap(document.getElementById('vrBtn'), toggleVR);
      bindTap(document.getElementById('vrClose'), closeVR);

      document.getElementById('vrStage').addEventListener('touchmove', (e)=>e.preventDefault(), {passive:false});
    }

    function init(){
      renderMissions();
      renderAchievements();
      renderQuiz();
      updateStats();
      wireEvents();

      // ilk y√ºkleme: DOM otursun diye 2 frame sonra sƒ±ƒüdƒ±r
      requestAnimationFrame(()=>{
        requestAnimationFrame(()=>{
          applyFit();
        });
      });

      window.addEventListener('resize', ()=>{
        applyFit();
        if(vrState.on) rebuildVR();
      });

      window.addEventListener('orientationchange', ()=>{
        setTimeout(()=>{
          applyFit();
          if(vrState.on) rebuildVR();
        }, 250);
      });
    }

    init();
  </script>
</body>
</html>
