<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HaritaG√∂z - AR Harita Okuryazarlƒ±ƒüƒ± Sim√ºlat√∂r√º</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a3a 0%, #2d4a5c 100%);
      color: #ffffff;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .header {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      border-bottom: 2px solid rgba(76, 175, 80, 0.3);
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #4CAF50;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .stats { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }

    .stat-item { text-align: center; min-width: 70px; }

    .stat-value { font-size: 22px; font-weight: bold; color: #FFC107; }

    .stat-label { font-size: 12px; color: #B0BEC5; }

    .bep-toggle {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.25s;
      user-select: none;
      -webkit-user-select: none;
    }
    .bep-toggle:hover { background: #1976D2; transform: scale(1.03); }
    .bep-toggle.active { background: #FF9800; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
      font-size: 28px;
      margin-bottom: 20px;
      color: #4CAF50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ar-simulator {
      background: #1a1a1a;
      border-radius: 15px;
      padding: 20px;
      position: relative;
      min-height: 500px;
      border: 3px solid #4CAF50;
      overflow: hidden;
    }

    .ar-viewport {
      position: relative;
      width: 100%;
      height: 450px;
      background: linear-gradient(to bottom, #87CEEB 0%, #90EE90 50%, #8B4513 100%);
      border-radius: 10px;
      overflow: hidden;
    }

    .map-layers {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    .layer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      transition: opacity 0.3s;
    }
    .layer.hidden { opacity: 0; pointer-events: none; }

    .topography-layer {
      background: repeating-linear-gradient(
        45deg,
        transparent, transparent 10px,
        rgba(139, 69, 19, 0.2) 10px,
        rgba(139, 69, 19, 0.2) 20px
      );
    }

    .roads-layer {
      background: repeating-linear-gradient(
        90deg,
        transparent, transparent 50px,
        rgba(255, 255, 0, 0.6) 50px,
        rgba(255, 255, 0, 0.6) 52px
      ),
      repeating-linear-gradient(
        0deg,
        transparent, transparent 80px,
        rgba(255, 255, 0, 0.6) 80px,
        rgba(255, 255, 0, 0.6) 82px
      );
    }

    .water-layer {
      background:
        radial-gradient(circle at 30% 70%, rgba(30, 144, 255, 0.6) 0%, transparent 30%),
        radial-gradient(circle at 70% 40%, rgba(30, 144, 255, 0.5) 0%, transparent 25%);
    }

    .settlement-layer {
      background:
        radial-gradient(circle at 50% 30%, rgba(255, 165, 0, 0.4) 0%, transparent 20%),
        radial-gradient(circle at 20% 60%, rgba(255, 165, 0, 0.3) 0%, transparent 15%),
        radial-gradient(circle at 80% 70%, rgba(255, 165, 0, 0.3) 0%, transparent 15%);
    }

    .risk-layer {
      background:
        radial-gradient(circle at 60% 80%, rgba(255, 0, 0, 0.5) 0%, transparent 25%),
        radial-gradient(circle at 25% 30%, rgba(255, 0, 0, 0.4) 0%, transparent 20%);
    }

    .ar-info-point {
      position: absolute;
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      animation: pulse 2s infinite;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .ar-info-point:hover { transform: scale(1.1); }

    @keyframes pulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .layer-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .layer-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      -webkit-user-select: none;
    }

    .layer-btn.topography { background: linear-gradient(135deg, #8B4513, #D2691E); color: white; }
    .layer-btn.roads { background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; }
    .layer-btn.water { background: linear-gradient(135deg, #1E90FF, #4169E1); color: white; }
    .layer-btn.settlement { background: linear-gradient(135deg, #FF6347, #FF8C00); color: white; }
    .layer-btn.risk { background: linear-gradient(135deg, #DC143C, #8B0000); color: white; }

    .layer-btn.inactive { opacity: 0.4; filter: grayscale(100%); }

    .layer-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .direction-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 220px;
      margin: 20px auto;
    }

    .direction-btn {
      padding: 15px;
      background: #2196F3;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.25s;
      user-select: none;
      -webkit-user-select: none;
    }
    .direction-btn:hover { background: #1976D2; transform: scale(1.06); }

    .direction-btn:nth-child(2) { grid-column: 2; }
    .direction-btn:nth-child(4) { grid-column: 1; }
    .direction-btn:nth-child(5) { grid-column: 3; }
    .direction-btn:nth-child(6) { grid-column: 2; }

    .missions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .mission-card {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(76, 175, 80, 0.2));
      padding: 20px;
      border-radius: 15px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
    }
    .mission-card:hover {
      transform: translateY(-4px);
      border-color: #4CAF50;
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.25);
    }
    .mission-card.completed {
      border-color: #4CAF50;
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3));
    }
    .mission-card.active { border-color: #FFC107; animation: glow 2s infinite; }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 193, 7, 0.35); }
      50% { box-shadow: 0 0 40px rgba(255, 193, 7, 0.65); }
    }

    .mission-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #4CAF50; }
    .mission-desc { font-size: 14px; color: #CFD8DC; margin-bottom: 15px; }
    .mission-reward { font-size: 16px; color: #FFC107; font-weight: bold; }

    .mission-status {
      position: absolute;
      top: 10px; right: 10px;
      width: 30px; height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .mission-status.locked { background: #757575; }
    .mission-status.active { background: #FFC107; }
    .mission-status.completed { background: #4CAF50; }

    .achievements {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .achievement {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.25s;
    }
    .achievement.unlocked { border-color: #FFC107; background: rgba(255, 193, 7, 0.1); }

    .achievement-icon { font-size: 48px; margin-bottom: 10px; filter: grayscale(100%); }
    .achievement.unlocked .achievement-icon { filter: grayscale(0%); animation: bounce 0.6s; }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-18px); }
    }

    .achievement-name { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
    .achievement-desc { font-size: 11px; color: #B0BEC5; }

    .quiz { margin-top: 20px; }

    .quiz-question {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
    }

    .quiz-question-text { font-size: 16px; margin-bottom: 15px; color: #E0E0E0; }
    .quiz-options { display: flex; flex-direction: column; gap: 10px; }

    .quiz-option {
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.25s;
      user-select: none;
      -webkit-user-select: none;
    }
    .quiz-option:hover { background: rgba(255, 255, 255, 0.15); border-color: #2196F3; }
    .quiz-option.selected { border-color: #FFC107; background: rgba(255, 193, 7, 0.2); }
    .quiz-option.correct { border-color: #4CAF50; background: rgba(76, 175, 80, 0.2); }
    .quiz-option.wrong { border-color: #F44336; background: rgba(244, 67, 54, 0.2); }

    .btn-primary {
      background: linear-gradient(135deg, #4CAF50, #8BC34A);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.25s;
      display: inline-block;
      margin-top: 20px;
      user-select: none;
      -webkit-user-select: none;
    }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(76, 175, 80, 0.35); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .result-panel {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(33, 150, 243, 0.2));
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin-top: 20px;
      border: 2px solid #4CAF50;
    }

    .result-score { font-size: 48px; font-weight: bold; color: #FFC107; margin-bottom: 10px; }
    .result-message { font-size: 20px; color: #E0E0E0; margin-bottom: 20px; }

    body.bep-mode { font-size: 18px; }
    body.bep-mode .section-title { font-size: 36px; }
    body.bep-mode .layer-btn,
    body.bep-mode .direction-btn,
    body.bep-mode .quiz-option { font-size: 18px; padding: 20px; }
    body.bep-mode .mission-card { padding: 30px; }
    body.bep-mode .btn-primary { font-size: 20px; padding: 20px 40px; }

    .hidden { display: none; }

    .task-prompt {
      background: rgba(255, 193, 7, 0.2);
      border: 2px solid #FFC107;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .task-prompt-title { font-size: 20px; font-weight: bold; color: #FFC107; margin-bottom: 10px; }
    .task-prompt-desc { font-size: 16px; color: #E0E0E0; }

    @media (max-width: 768px){
      .logo { font-size: 22px; }
      .container { padding: 18px 14px; }
      .ar-simulator { min-height: 440px; }
      .ar-viewport { height: 360px; }
      .layer-btn { padding: 14px 16px; }
    }

    /* ===== VR Overlay (WhatsApp uyumlu) ===== */
    .vr-stage{
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 9999;

      /* display yerine visibility daha stabil */
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
    }
    body.vr-on .vr-stage{
      visibility: visible;
      opacity: 1;
      pointer-events: auto;
    }

    .vr-eye{
      position: absolute;
      top: 0;
      width: 50vw;
      height: 100vh;
      overflow: hidden;
    }
    .vr-eye.left{ left: 0; }
    .vr-eye.right{ right: 0; }

    .vr-content{ transform-origin: top left; }

    .focus-ring{
      outline: 3px solid rgba(255,193,7,0.95);
      outline-offset: 4px;
      border-radius: 12px;
    }

    .hud{
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 10000;
      font-size: 12px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      max-width: 76vw;
    }
    body.vr-on .hud{ bottom: 20px; }
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">üó∫Ô∏è HaritaG√∂z</div>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Puan</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="level">1</div>
        <div class="stat-label">Seviye</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="missions-completed">0/8</div>
        <div class="stat-label">G√∂rev</div>
      </div>

      <button class="bep-toggle" id="bep-toggle" type="button">BEP Modu</button>
      <button class="bep-toggle" id="vr-toggle" type="button" style="background:#6A1B9A;">VR Modu</button>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <div class="section-title">üéØ AR Harita Sim√ºlat√∂r√º</div>

      <div class="task-prompt" id="current-task">
        <div class="task-prompt-title">Ho≈ü Geldiniz!</div>
        <div class="task-prompt-desc">Katmanlarƒ± a√ßƒ±p kapatarak haritayƒ± ke≈üfedin. Y√∂n butonlarƒ±yla farklƒ± b√∂lgelere bakƒ±n.</div>
      </div>

      <div class="ar-simulator">
        <div class="ar-viewport" id="ar-viewport">
          <div class="map-layers">
            <div class="layer topography-layer" id="layer-topography"></div>
            <div class="layer roads-layer hidden" id="layer-roads"></div>
            <div class="layer water-layer hidden" id="layer-water"></div>
            <div class="layer settlement-layer hidden" id="layer-settlement"></div>
            <div class="layer risk-layer hidden" id="layer-risk"></div>
          </div>

          <div class="ar-info-point" style="top: 30%; left: 30%;" data-info="topography">üìä Topografya</div>
          <div class="ar-info-point" style="top: 70%; left: 60%;" data-info="risk">‚ö†Ô∏è Risk B√∂lgesi</div>
          <div class="ar-info-point" style="top: 40%; left: 70%;" data-info="water">üíß Su Kaynaƒüƒ±</div>
        </div>

        <div class="layer-controls">
          <button class="layer-btn topography" data-layer="topography" type="button">üèîÔ∏è Topografya</button>
          <button class="layer-btn roads inactive" data-layer="roads" type="button">üõ£Ô∏è Ula≈üƒ±m Aƒülarƒ±</button>
          <button class="layer-btn water inactive" data-layer="water" type="button">üíß Su Kaynaklarƒ±</button>
          <button class="layer-btn settlement inactive" data-layer="settlement" type="button">üèòÔ∏è Yerle≈üim</button>
          <button class="layer-btn risk inactive" data-layer="risk" type="button">‚ö†Ô∏è Risk B√∂lgeleri</button>
        </div>

        <div class="direction-controls">
          <button class="direction-btn" data-direction="nw" type="button">‚ÜñÔ∏è</button>
          <button class="direction-btn" data-direction="n" type="button">‚¨ÜÔ∏è</button>
          <button class="direction-btn" data-direction="ne" type="button">‚ÜóÔ∏è</button>
          <button class="direction-btn" data-direction="w" type="button">‚¨ÖÔ∏è</button>
          <button class="direction-btn" data-direction="e" type="button">‚û°Ô∏è</button>
          <button class="direction-btn" data-direction="sw" type="button">‚ÜôÔ∏è</button>
          <button class="direction-btn" data-direction="s" type="button">‚¨áÔ∏è</button>
          <button class="direction-btn" data-direction="se" type="button">‚ÜòÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üéØ G√∂revler</div>
      <div class="missions" id="missions"></div>
    </div>

    <div class="section">
      <div class="section-title">üèÜ Ba≈üarƒ±mlar</div>
      <div class="achievements" id="achievements"></div>
    </div>

    <div class="section" id="quiz-section">
      <div class="section-title">üìù Harita Okuryazarlƒ±ƒüƒ± Testi</div>
      <div class="quiz" id="quiz"></div>
      <button class="btn-primary" id="check-answers" type="button">Cevaplarƒ± Kontrol Et</button>
      <div class="result-panel hidden" id="quiz-result">
        <div class="result-score" id="quiz-score"></div>
        <div class="result-message" id="quiz-message"></div>
      </div>
    </div>
  </div>

  <!-- VR Overlay -->
  <div class="vr-stage" id="vr-stage" aria-hidden="true">
    <div class="vr-eye left"><div class="vr-content" id="vr-left"></div></div>
    <div class="vr-eye right"><div class="vr-content" id="vr-right"></div></div>
  </div>

  <div class="hud hidden" id="hud">Hazƒ±r</div>

  <script>
    // Game State
    const gameState = {
      score: 0,
      level: 1,
      completedMissions: 0,
      activeLayers: ['topography'],
      currentDirection: 'n',
      achievements: [],
      bepMode: false
    };

    // Missions Data
    const missions = [
      { id: 1, title: 'Katmanlarƒ± Ke≈üfet', desc: 'T√ºm harita katmanlarƒ±nƒ± a√ß ve kapat', reward: 50, status: 'active', check: () => gameState.activeLayers.length >= 3 },
      { id: 2, title: 'Y√∂n Bul', desc: '4 farklƒ± y√∂ne bak ve bilgi noktalarƒ±nƒ± ke≈üfet', reward: 75, status: 'locked', check: () => gameState.directionsExplored >= 4 },
      { id: 3, title: 'Risk Analizi', desc: 'Risk katmanƒ±nƒ± a√ß ve risk b√∂lgesini incele', reward: 100, status: 'locked', check: () => gameState.activeLayers.includes('risk') && gameState.riskPointClicked },
      { id: 4, title: 'Su Kaynaklarƒ±', desc: 'Su kaynaklarƒ± katmanƒ±nƒ± kullanarak su noktasƒ±nƒ± bul', reward: 100, status: 'locked', check: () => gameState.activeLayers.includes('water') && gameState.waterPointClicked },
      { id: 5, title: 'G√ºzergah Planlama', desc: 'Ula≈üƒ±m aƒülarƒ± katmanƒ±nƒ± kullanarak en uygun yolu belirle', reward: 150, status: 'locked', check: () => gameState.activeLayers.includes('roads') && gameState.roadsExplored },
      { id: 6, title: 'Yerle≈üim Analizi', desc: 'Yerle≈üim katmanƒ±nƒ± kullanarak n√ºfus yoƒüunluƒüunu incele', reward: 150, status: 'locked', check: () => gameState.activeLayers.includes('settlement') },
      { id: 7, title: 'Harita Uzmanƒ±', desc: 'Harita okuryazarlƒ±ƒüƒ± testini tamamla', reward: 200, status: 'locked', check: () => gameState.quizCompleted },
      { id: 8, title: 'AR Ustasƒ±', desc: 'T√ºm g√∂revleri tamamla ve 1000 puan kazan', reward: 300, status: 'locked', check: () => gameState.completedMissions >= 7 && gameState.score >= 1000 }
    ];

    // Achievements Data
    const achievements = [
      { id: 1, icon: 'üó∫Ô∏è', name: 'ƒ∞lk Ke≈üif', desc: 'ƒ∞lk katmanƒ± a√ßtƒ±n', unlocked: false },
      { id: 2, icon: 'üß≠', name: 'Y√∂n Bulma', desc: '4 y√∂ne baktƒ±n', unlocked: false },
      { id: 3, icon: '‚ö†Ô∏è', name: 'Risk Farkƒ±ndalƒ±ƒüƒ±', desc: 'Risk b√∂lgesini tespit ettin', unlocked: false },
      { id: 4, icon: 'üíß', name: 'Su Ka≈üifi', desc: 'Su kaynaƒüƒ±nƒ± buldun', unlocked: false },
      { id: 5, icon: 'üèÜ', name: 'ƒ∞lk G√∂rev', desc: 'ƒ∞lk g√∂revi tamamladƒ±n', unlocked: false },
      { id: 6, icon: 'üìö', name: 'Bilgi Avcƒ±sƒ±', desc: '500 puana ula≈ütƒ±n', unlocked: false },
      { id: 7, icon: 'üéì', name: 'Harita Uzmanƒ±', desc: 'Testi ge√ßtin', unlocked: false },
      { id: 8, icon: 'üëë', name: 'AR Ustasƒ±', desc: 'T√ºm g√∂revleri tamamladƒ±n', unlocked: false }
    ];

    // Quiz Questions
    const quizQuestions = [
      { question: 'Haritada y√ºksekliƒüi g√∂steren katman hangisidir?', options: ['Topografya', 'Ula≈üƒ±m', 'Yerle≈üim', 'Risk B√∂lgeleri'], correct: 0 },
      { question: 'Sel riski analizi i√ßin hangi katmanlar birlikte kullanƒ±lmalƒ±dƒ±r?', options: ['Sadece risk', 'Su kaynaklarƒ± ve topografya', 'Sadece yerle≈üim', 'Sadece ula≈üƒ±m'], correct: 1 },
      { question: 'Bir b√∂lgenin n√ºfus yoƒüunluƒüunu anlamak i√ßin hangi katman kullanƒ±lƒ±r?', options: ['Topografya', 'Su kaynaklarƒ±', 'Yerle≈üim', 'Ula≈üƒ±m'], correct: 2 },
      { question: 'Yaya i√ßin g√ºvenli g√ºzergah planlarken hangi katmanlar √∂nemlidir?', options: ['Ula≈üƒ±m ve risk b√∂lgeleri', 'Sadece topografya', 'Sadece su', 'Sadece yerle≈üim'], correct: 0 },
      { question: 'AR (Artƒ±rƒ±lmƒ±≈ü Ger√ßeklik) harita uygulamalarƒ±nƒ±n avantajƒ± nedir?', options: ['Daha pahalƒ±dƒ±r', 'Ger√ßek √ßevre ile harita birle≈üir', 'Sadece sƒ±nƒ±fta kullanƒ±lƒ±r', 'Tek katman g√∂sterir'], correct: 1 }
    ];

    // Initialize counters
    gameState.directionsExplored = 0;
    gameState.layersUsed = new Set();
    gameState.riskPointClicked = false;
    gameState.waterPointClicked = false;
    gameState.roadsExplored = false;
    gameState.quizCompleted = false;

    function renderMissions() {
      const container = document.getElementById('missions');
      container.innerHTML = missions.map(m => `
        <div class="mission-card ${m.status}" data-mission-id="${m.id}">
          <div class="mission-status ${m.status}">
            ${m.status === 'locked' ? 'üîí' : m.status === 'active' ? '‚ö°' : '‚úÖ'}
          </div>
          <div class="mission-title">${m.title}</div>
          <div class="mission-desc">${m.desc}</div>
          <div class="mission-reward">+${m.reward} Puan</div>
        </div>
      `).join('');
    }

    function renderAchievements() {
      const container = document.getElementById('achievements');
      container.innerHTML = achievements.map(a => `
        <div class="achievement ${a.unlocked ? 'unlocked' : ''}" data-ach-id="${a.id}">
          <div class="achievement-icon">${a.icon}</div>
          <div class="achievement-name">${a.name}</div>
          <div class="achievement-desc">${a.desc}</div>
        </div>
      `).join('');
    }

    function renderQuiz() {
      const container = document.getElementById('quiz');
      container.innerHTML = quizQuestions.map((q, i) => `
        <div class="quiz-question" data-question="${i}">
          <div class="quiz-question-text">${i + 1}. ${q.question}</div>
          <div class="quiz-options">
            ${q.options.map((opt, j) => `
              <div class="quiz-option" data-question="${i}" data-option="${j}">${opt}</div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function setupEventListeners() {
      // Layer buttons
      document.querySelectorAll('.layer-btn').forEach(btn => {
        btn.addEventListener('click', () => toggleLayer(btn.dataset.layer));
      });

      // Direction buttons
      document.querySelectorAll('.direction-btn').forEach(btn => {
        btn.addEventListener('click', () => changeDirection(btn.dataset.direction));
      });

      // Info points
      document.querySelectorAll('.ar-info-point').forEach(point => {
        point.addEventListener('click', () => clickInfoPoint(point.dataset.info));
      });

      // Quiz options (delegation)
      document.addEventListener('click', (e) => {
        const opt = e.target.closest('.quiz-option');
        if (opt) selectQuizOption(opt);
      });

      // Check answers
      document.getElementById('check-answers').addEventListener('click', checkQuizAnswers);

      // BEP toggle
      document.getElementById('bep-toggle').addEventListener('click', toggleBEPMode);

      // VR toggle - click + touchstart (WhatsApp bazen click'i geciktiriyor)
      const vrBtn = document.getElementById('vr-toggle');
      vrBtn.addEventListener('click', toggleVRMode);
      vrBtn.addEventListener('touchstart', (e) => {
        // iOS WhatsApp'ta daha hƒ±zlƒ± tetiklemek i√ßin:
        e.preventDefault();
        toggleVRMode();
      }, {passive:false});
    }

    function updateStats() {
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('level').textContent = gameState.level;
    }

    function updateMissionCounter() {
      document.getElementById('missions-completed').textContent = `${gameState.completedMissions}/${missions.length}`;
    }

    function addScore(points) {
      gameState.score += points;
      updateStats();

      if (gameState.score >= 500 && !achievements[5].unlocked) unlockAchievement(6);

      const newLevel = Math.floor(gameState.score / 200) + 1;
      if (newLevel > gameState.level) {
        gameState.level = newLevel;
        updateStats();
      }
    }

    function unlockAchievement(id) {
      const ach = achievements.find(a => a.id === id);
      if (ach && !ach.unlocked) {
        ach.unlocked = true;
        renderAchievements();
        addScore(50);
      }
    }

    function toggleLayer(layerName) {
      const layer = document.getElementById(`layer-${layerName}`);
      const btn = document.querySelector(`.layer-btn[data-layer="${layerName}"]`);

      if (layer.classList.contains('hidden')) {
        layer.classList.remove('hidden');
        btn.classList.remove('inactive');
        if (!gameState.activeLayers.includes(layerName)) gameState.activeLayers.push(layerName);
        gameState.layersUsed.add(layerName);
      } else {
        layer.classList.add('hidden');
        btn.classList.add('inactive');
        gameState.activeLayers = gameState.activeLayers.filter(l => l !== layerName);
      }

      if (gameState.layersUsed.size === 1 && !achievements[0].unlocked) unlockAchievement(1);
      if (layerName === 'roads') gameState.roadsExplored = true;

      checkMissions();
      refreshVRStereo();
    }

    function changeDirection(direction) {
      gameState.currentDirection = direction;
      gameState.directionsExplored++;

      const viewport = document.getElementById('ar-viewport');
      viewport.style.filter = 'brightness(1.2)';
      setTimeout(() => viewport.style.filter = 'brightness(1)', 200);

      if (gameState.directionsExplored >= 4 && !achievements[1].unlocked) unlockAchievement(2);

      checkMissions();
      refreshVRStereo();
    }

    function clickInfoPoint(type) {
      if (type === 'risk') {
        gameState.riskPointClicked = true;
        if (!achievements[2].unlocked) unlockAchievement(3);
      } else if (type === 'water') {
        gameState.waterPointClicked = true;
        if (!achievements[3].unlocked) unlockAchievement(4);
      }

      addScore(25);
      checkMissions();
      refreshVRStereo();
    }

    function checkMissions() {
      missions.forEach((m, idx) => {
        if (m.status === 'active' && m.check()) completeMission(idx);
        else if (m.status === 'locked' && idx > 0) {
          if (missions[idx - 1].status === 'completed') m.status = 'active';
        }
      });
      renderMissions();
      updateMissionCounter();
    }

    function completeMission(index) {
      const m = missions[index];
      if (m.status !== 'completed') {
        m.status = 'completed';
        gameState.completedMissions++;
        addScore(m.reward);

        if (gameState.completedMissions === 1 && !achievements[4].unlocked) unlockAchievement(5);

        if (index < missions.length - 1) missions[index + 1].status = 'active';

        renderMissions();
        updateMissionCounter();
      }
    }

    function selectQuizOption(opt) {
      const qId = opt.dataset.question;
      document.querySelectorAll(`.quiz-option[data-question="${qId}"]`).forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      refreshVRStereo();
    }

    function checkQuizAnswers() {
      let correctCount = 0;

      quizQuestions.forEach((q, i) => {
        const selected = document.querySelector(`.quiz-option[data-question="${i}"].selected`);
        const allOptions = document.querySelectorAll(`.quiz-option[data-question="${i}"]`);

        if (selected) {
          const selectedOption = parseInt(selected.dataset.option, 10);

          allOptions.forEach(opt => {
            const optionIndex = parseInt(opt.dataset.option, 10);
            if (optionIndex === q.correct) opt.classList.add('correct');
            else if (opt.classList.contains('selected')) opt.classList.add('wrong');
          });

          if (selectedOption === q.correct) correctCount++;
        }
      });

      const resultPanel = document.getElementById('quiz-result');
      const scoreEl = document.getElementById('quiz-score');
      const messageEl = document.getElementById('quiz-message');

      scoreEl.textContent = `${correctCount}/${quizQuestions.length}`;

      const percentage = (correctCount / quizQuestions.length) * 100;
      if (percentage >= 80) {
        messageEl.textContent = 'M√ºkemmel! Harita okuryazarlƒ±ƒüƒ±nda ustasƒ±n! üèÜ';
        addScore(200);
        if (!achievements[6].unlocked) unlockAchievement(7);
      } else if (percentage >= 60) {
        messageEl.textContent = 'ƒ∞yi! Geli≈ümeye devam et! üëç';
        addScore(150);
      } else {
        messageEl.textContent = 'Daha fazla pratik yapmalƒ±sƒ±n! üí™';
        addScore(100);
      }

      resultPanel.classList.remove('hidden');
      document.getElementById('check-answers').disabled = true;

      gameState.quizCompleted = true;
      checkMissions();
      refreshVRStereo();
    }

    function toggleBEPMode() {
      gameState.bepMode = !gameState.bepMode;
      document.body.classList.toggle('bep-mode');

      const btn = document.getElementById('bep-toggle');
      btn.classList.toggle('active');
      btn.textContent = gameState.bepMode ? 'Normal Mod' : 'BEP Modu';

      refreshVRStereo();
    }

    // ======================
    // VR + Kumanda Kontrolleri (WhatsApp uyumlu)
    // ======================
    const vrState = {
      enabled: false,
      focusables: [],
      focusIndex: 0
    };

    function showHUD(msg, ms = 1400){
      const hud = document.getElementById('hud');
      hud.textContent = msg;
      hud.classList.remove('hidden');
      clearTimeout(showHUD._t);
      showHUD._t = setTimeout(() => hud.classList.add('hidden'), ms);
    }

    function getFocusableElements(){
      return [
        ...document.querySelectorAll('button.layer-btn'),
        ...document.querySelectorAll('button.direction-btn'),
        ...document.querySelectorAll('.ar-info-point'),
        ...document.querySelectorAll('.quiz-option'),
        document.getElementById('check-answers'),
        document.getElementById('bep-toggle'),
        document.getElementById('vr-toggle')
      ].filter(Boolean);
    }

    function clearFocusRing(){
      document.querySelectorAll('.focus-ring').forEach(el => el.classList.remove('focus-ring'));
    }

    function setFocus(index){
      vrState.focusables = getFocusableElements();
      if (vrState.focusables.length === 0) return;

      vrState.focusIndex = (index + vrState.focusables.length) % vrState.focusables.length;
      clearFocusRing();
      const el = vrState.focusables[vrState.focusIndex];
      el.classList.add('focus-ring');

      if (!vrState.enabled) {
        el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
      }
    }

    function activateFocused(){
      const el = vrState.focusables[vrState.focusIndex];
      if (!el) return;
      el.click();
    }

    function calcVrScale(){
      const w = window.innerWidth;
      if (w <= 390) return 0.72;
      if (w <= 430) return 0.78;
      if (w <= 480) return 0.82;
      return 0.9;
    }

    function buildVRStereo(){
      const left = document.getElementById('vr-left');
      const right = document.getElementById('vr-right');
      left.innerHTML = '';
      right.innerHTML = '';

      // ger√ßek DOM'u klonla (VR g√∂r√ºnt√ºs√º)
      const headerClone = document.querySelector('.header').cloneNode(true);
      const containerClone = document.querySelector('.container').cloneNode(true);

      // klonlar tƒ±klanmasƒ±n
      headerClone.style.pointerEvents = 'none';
      containerClone.style.pointerEvents = 'none';

      const wrapL = document.createElement('div');
      wrapL.className = 'vr-content';
      wrapL.style.width = '100vw';
      wrapL.style.minHeight = '100vh';
      wrapL.appendChild(headerClone);
      wrapL.appendChild(containerClone);

      const wrapR = wrapL.cloneNode(true);

      const s = calcVrScale();
      wrapL.style.transform = `scale(${s})`;
      wrapR.style.transform = `scale(${s})`;

      left.appendChild(wrapL);
      right.appendChild(wrapR);
    }

    function teardownVRStereo(){
      document.getElementById('vr-left').innerHTML = '';
      document.getElementById('vr-right').innerHTML = '';
    }

    function refreshVRStereo(){
      if (!vrState.enabled) return;
      buildVRStereo();
    }

    function toggleVRMode(){
      try {
        vrState.enabled = !vrState.enabled;

        document.body.classList.toggle('vr-on', vrState.enabled);

        const stage = document.getElementById('vr-stage');
        stage.setAttribute('aria-hidden', vrState.enabled ? 'false' : 'true');

        const vrBtn = document.getElementById('vr-toggle');
        vrBtn.classList.toggle('active', vrState.enabled);
        vrBtn.textContent = vrState.enabled ? 'VR Kapat' : 'VR Modu';

        if (vrState.enabled) {
          showHUD('VR a√ßƒ±lƒ±yor...', 1500);

          // WhatsApp WebView'de √ßizim gecikebilir: k√º√ß√ºk gecikme ile build
          setTimeout(() => {
            buildVRStereo();
            setFocus(0);
            showHUD('VR A√ßƒ±k | Ok: gezin | Enter: se√ß | Back: √ßƒ±k', 2200);
          }, 120);

        } else {
          teardownVRStereo();
          clearFocusRing();
          showHUD('VR Kapalƒ±', 900);
        }
      } catch (err) {
        alert('VR hata: ' + (err?.message || err));
      }
    }

    function handleKey(e){
      const key = e.key;

      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(key)) {
        e.preventDefault();
      }

      if (key === 'ArrowRight' || key === 'ArrowDown') { setFocus(vrState.focusIndex + 1); return; }
      if (key === 'ArrowLeft' || key === 'ArrowUp') { setFocus(vrState.focusIndex - 1); return; }

      if (key === 'Enter' || key === ' ') {
        activateFocused();
        refreshVRStereo();
        return;
      }

      if (key === 'Escape' || key === 'Backspace') {
        if (vrState.enabled) toggleVRMode();
        return;
      }

      // Kƒ±sayollar
      if (key === 'v' || key === 'V') { toggleVRMode(); return; }
      if (key === 'b' || key === 'B') { toggleBEPMode(); return; }

      if (['1','2','3','4','5'].includes(key)) {
        const layerMap = { '1':'topography','2':'roads','3':'water','4':'settlement','5':'risk' };
        toggleLayer(layerMap[key]);
        return;
      }
    }

    // Gamepad polling (bazƒ± kumandalar)
    let gpPollHandle = null;
    let gpLast = { a:false, b:false, up:false, down:false, left:false, right:false };

    function startGamepadPolling(){
      if (gpPollHandle) return;
      gpPollHandle = setInterval(() => {
        const gps = navigator.getGamepads ? navigator.getGamepads() : [];
        const gp = gps && gps[0];
        if (!gp) return;

        const a = gp.buttons[0]?.pressed;
        const b = gp.buttons[1]?.pressed;

        const ax0 = gp.axes[0] ?? 0;
        const ax1 = gp.axes[1] ?? 0;

        const right = ax0 > 0.6;
        const left  = ax0 < -0.6;
        const down  = ax1 > 0.6;
        const up    = ax1 < -0.6;

        if (right && !gpLast.right) setFocus(vrState.focusIndex + 1);
        if (left  && !gpLast.left ) setFocus(vrState.focusIndex - 1);
        if (down  && !gpLast.down ) setFocus(vrState.focusIndex + 1);
        if (up    && !gpLast.up   ) setFocus(vrState.focusIndex - 1);

        if (a && !gpLast.a) { activateFocused(); refreshVRStereo(); }
        if (b && !gpLast.b) { if (vrState.enabled) toggleVRMode(); }

        gpLast = { a, b, up, down, left, right };
      }, 90);
    }

    function setupVRControls(){
      window.addEventListener('keydown', handleKey, {passive:false});

      window.addEventListener('gamepadconnected', () => {
        startGamepadPolling();
        showHUD('Gamepad baƒülandƒ±', 1000);
      });

      startGamepadPolling();
      window.addEventListener('resize', () => refreshVRStereo());
    }

    function init(){
      renderMissions();
      renderAchievements();
      renderQuiz();
      setupEventListeners();
      setupVRControls();
      updateStats();
      updateMissionCounter();
      setFocus(0);
      showHUD('Hazƒ±r: Ok/Enter ile gezinebilirsin', 1600);
    }

    init();
  </script>
</body>
</html>
